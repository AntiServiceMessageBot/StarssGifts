# bot.py - –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä–µ–Ω—å –≤ Telegram
# –ü—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∫–æ–¥ –¥–ª—è —Ö–æ—Å—Ç–∏–Ω–≥–∞ Bothost.ru

import asyncio
import logging
import sqlite3
import random
import os
import json
from datetime import datetime, timedelta
from typing import Dict, Optional, Tuple
import re
import string

from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import (
    Message, CallbackQuery, InlineKeyboardMarkup, 
    InlineKeyboardButton, ReplyKeyboardRemove
)

# ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
BOT_TOKEN = os.getenv("BOT_TOKEN", "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê")  # –¢–æ–∫–µ–Ω –æ—Ç @BotFather
OWNER_USERNAME = "timyr2011"  # –Æ–∑–µ—Ä–Ω–µ–π–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–±–µ–∑ @)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –Ø–Ω–¥–µ–∫—Å GPT (–ø–æ–ª—É—á–∏—Ç—å –Ω–∞ https://console.cloud.yandex.ru)
YANDEX_FOLDER_ID = os.getenv("YANDEX_FOLDER_ID", "–≤–∞—à_folder_id")
YANDEX_API_KEY = os.getenv("YANDEX_API_KEY", "–≤–∞—à_api_–∫–ª—é—á")

# –≠–º–æ–¥–∑–∏ –¥–ª—è —É–∫—Ä–∞—à–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—Ä–∞—Å–∏–≤—ã–µ)
EMOJI = {
    "hello": "üëã",
    "heart": "‚ù§Ô∏è",
    "girl": "üëß",
    "boy": "üë®",
    "star": "‚≠ê",
    "crown": "üëë",
    "diamond": "üíé",
    "gift": "üéÅ",
    "money": "üí∞",
    "time": "‚è∞",
    "sleep": "üåô",
    "morning": "‚òÄÔ∏è",
    "night": "üåÉ",
    "dream": "üí≠",
    "photo": "üì∏",
    "video": "üé•",
    "voice": "üé§",
    "circle": "üîÑ",
    "settings": "‚öôÔ∏è",
    "success": "‚úÖ",
    "error": "‚ùå",
    "warning": "‚ö†Ô∏è",
    "back": "‚óÄÔ∏è",
    "buy": "üí≥",
    "free": "üÜì",
    "pro": "üíé",
    "promax": "üëë"
}

# ========== –ë–ê–ó–ê –î–ê–ù–ù–´–• ==========
class Database:
    def __init__(self):
        self.conn = sqlite3.connect("bot_database.db", check_same_thread=False)
        self.cursor = self.conn.cursor()
        self.create_tables()
    
    def create_tables(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü"""
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–¥–µ–≤—É—à–∫–∏)
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                first_name TEXT,
                name TEXT,
                age INTEGER,
                tariff TEXT DEFAULT 'free',
                tariff_expires TEXT,
                tariff_code TEXT,
                tariff_number INTEGER,
                boy_name TEXT,
                boy_age INTEGER,
                boy_style TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –ü–æ–¥–ø–∏—Å–∫–∏
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS subscriptions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                tariff TEXT,
                code TEXT UNIQUE,
                number INTEGER,
                expires TEXT,
                is_active INTEGER DEFAULT 1,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –ú–µ–¥–∏–∞ —Ñ–∞–π–ª—ã (—Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, –∫—Ä—É–∂–∫–∏, –≥–æ–ª–æ—Å–æ–≤—ã–µ)
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS media (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                file_id TEXT,
                file_type TEXT,
                age_range TEXT,
                name TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –†–∞–∑–≥–æ–≤–æ—Ä—ã (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS conversations (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                message TEXT,
                response TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        self.conn.commit()
    
    # ===== –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ =====
    def add_user(self, user_id: int, username: str = "", first_name: str = ""):
        """–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        self.cursor.execute(
            'INSERT OR IGNORE INTO users (user_id, username, first_name) VALUES (?, ?, ?)',
            (user_id, username, first_name)
        )
        self.conn.commit()
    
    def get_user(self, user_id: int) -> Optional[Dict]:
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        self.cursor.execute('SELECT * FROM users WHERE user_id = ?', (user_id,))
        row = self.cursor.fetchone()
        if row:
            columns = [desc[0] for desc in self.cursor.description]
            return dict(zip(columns, row))
        return None
    
    def update_user_name(self, user_id: int, name: str):
        """–û–±–Ω–æ–≤–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        self.cursor.execute('UPDATE users SET name = ? WHERE user_id = ?', (name, user_id))
        self.conn.commit()
    
    def update_user_age(self, user_id: int, age: int):
        """–û–±–Ω–æ–≤–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        self.cursor.execute('UPDATE users SET age = ? WHERE user_id = ?', (age, user_id))
        self.conn.commit()
    
    def update_user_boy(self, user_id: int, boy_name: str, boy_age: int, boy_style: str = ""):
        """–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–Ω—è"""
        self.cursor.execute(
            'UPDATE users SET boy_name = ?, boy_age = ?, boy_style = ? WHERE user_id = ?',
            (boy_name, boy_age, boy_style, user_id)
        )
        self.conn.commit()
    
    # ===== –¢–∞—Ä–∏—Ñ—ã =====
    def set_tariff(self, user_id: int, tariff: str, expires: str = None, code: str = None, number: int = None):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        self.cursor.execute(
            '''UPDATE users SET tariff = ?, tariff_expires = ?, tariff_code = ?, tariff_number = ? 
               WHERE user_id = ?''',
            (tariff, expires, code, number, user_id)
        )
        self.conn.commit()
    
    def add_subscription(self, user_id: int, tariff: str, code: str, number: int, expires: str):
        """–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –æ –ø–æ–¥–ø–∏—Å–∫–µ"""
        self.cursor.execute(
            'INSERT INTO subscriptions (user_id, tariff, code, number, expires) VALUES (?, ?, ?, ?, ?)',
            (user_id, tariff, code, number, expires)
        )
        self.conn.commit()
    
    def get_subscription_by_code(self, code: str) -> Optional[Dict]:
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –ø–æ –∫–æ–¥—É"""
        self.cursor.execute('SELECT * FROM subscriptions WHERE code = ?', (code,))
        row = self.cursor.fetchone()
        if row:
            columns = [desc[0] for desc in self.cursor.description]
            return dict(zip(columns, row))
        return None
    
    def deactivate_subscription(self, code: str):
        """–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"""
        self.cursor.execute('UPDATE subscriptions SET is_active = 0 WHERE code = ?', (code,))
        self.cursor.execute('UPDATE users SET tariff = "free" WHERE tariff_code = ?', (code,))
        self.conn.commit()
    
    def get_next_number(self) -> int:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä –ø–æ–¥–ø–∏—Å–∫–∏"""
        self.cursor.execute('SELECT MAX(number) FROM subscriptions')
        result = self.cursor.fetchone()[0]
        return (result or 0) + 1
    
    # ===== –ú–µ–¥–∏–∞ =====
    def add_media(self, file_id: str, file_type: str, age_range: str, name: str):
        """–î–æ–±–∞–≤–∏—Ç—å –º–µ–¥–∏–∞ —Ñ–∞–π–ª"""
        self.cursor.execute(
            'INSERT INTO media (file_id, file_type, age_range, name) VALUES (?, ?, ?, ?)',
            (file_id, file_type, age_range, name)
        )
        self.conn.commit()
    
    def get_media_by_age(self, age_range: str, file_type: str = None) -> Optional[Dict]:
        """–ü–æ–ª—É—á–∏—Ç—å –º–µ–¥–∏–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É"""
        if file_type:
            self.cursor.execute(
                'SELECT * FROM media WHERE age_range = ? AND file_type = ? ORDER BY RANDOM() LIMIT 1',
                (age_range, file_type)
            )
        else:
            self.cursor.execute(
                'SELECT * FROM media WHERE age_range = ? ORDER BY RANDOM() LIMIT 1',
                (age_range,)
            )
        row = self.cursor.fetchone()
        if row:
            columns = [desc[0] for desc in self.cursor.description]
            return dict(zip(columns, row))
        return None
    
    # ===== –†–∞–∑–≥–æ–≤–æ—Ä—ã =====
    def save_conversation(self, user_id: int, message: str, response: str):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä"""
        self.cursor.execute(
            'INSERT INTO conversations (user_id, message, response) VALUES (?, ?, ?)',
            (user_id, message, response)
        )
        self.conn.commit()
    
    def get_recent_conversations(self, user_id: int, limit: int = 5) -> list:
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã"""
        self.cursor.execute(
            'SELECT * FROM conversations WHERE user_id = ? ORDER BY created_at DESC LIMIT ?',
            (user_id, limit)
        )
        rows = self.cursor.fetchall()
        columns = [desc[0] for desc in self.cursor.description]
        return [dict(zip(columns, row)) for row in rows]

# ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(storage=MemoryStorage())
db = Database()

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ========== –°–û–°–¢–û–Ø–ù–ò–Ø ==========
class RegisterStates(StatesGroup):
    waiting_name = State()
    waiting_age = State()
    waiting_style = State()

class TariffStates(StatesGroup):
    choosing = State()

class OwnerStates(StatesGroup):
    waiting_command = State()

# ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

def get_obrashchenie(user_name: str) -> str:
    """–í—ã–±—Ä–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ —Å –∑–∞–¥–∞–Ω–Ω—ã–º–∏ —à–∞–Ω—Å–∞–º–∏"""
    rand = random.random() * 100  # 0-100
    
    if rand < 48:  # 48% - –∏–º—è
        return user_name
    elif rand < 50:  # 2% - –∂–µ–Ω–∞
        return "–∂–µ–Ω–∞"
    elif rand < 70:  # 20% - –ª—é–±–∏–º–∞—è
        return "–ª—é–±–∏–º–∞—è"
    elif rand < 75:  # 5% - –º–æ–π –∫–æ—Ç–µ–Ω–æ–∫
        return "–º–æ–π –∫–æ—Ç–µ–Ω–æ–∫"
    elif rand < 80:  # 5% - –º–æ—è –ª—é–±–æ–≤—å
        return "–º–æ—è –ª—é–±–æ–≤—å"
    elif rand < 90:  # 10% - –Ω–∏—á–µ–≥–æ
        return ""
    else:  # 10% - –º–æ—è —Ç—ã –¥–µ–≤–æ—á–∫–∞
        return "–º–æ—è —Ç—ã –¥–µ–≤–æ—á–∫–∞"

def check_tariff_expired(user: Dict) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –∏—Å—Ç–µ–∫ –ª–∏ —Ç–∞—Ä–∏—Ñ"""
    if user['tariff'] == 'free':
        return False
    
    if user['tariff_expires']:
        expires = datetime.fromisoformat(user['tariff_expires'])
        if datetime.now() > expires:
            return True
    
    return False

def generate_code() -> str:
    """–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏–∑ –∑–∞–≥–ª–∞–≤–Ω—ã—Ö –±—É–∫–≤ –∏ —Ü–∏—Ñ—Ä"""
    chars = string.ascii_uppercase + string.digits
    return ''.join(random.choices(chars, k=8))

async def ask_yandex_gpt(prompt: str, user: Dict, is_pro: bool = False) -> str:
    """–°–ø—Ä–æ—Å–∏—Ç—å —É –Ø–Ω–¥–µ–∫—Å GPT"""
    try:
        import aiohttp
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–¥–µ–ª—å
        if user.get('tariff') == 'promax':
            model = "yandexgpt/latest"  # –°–∞–º–∞—è —É–º–Ω–∞—è
        elif user.get('tariff') == 'pro':
            model = "yandexgpt"  # –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è
        else:
            model = "yandexgpt-lite"  # –£—Ä–µ–∑–∞–Ω–Ω–∞—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
        boy_age = user.get('boy_age', 25)
        style = user.get('boy_style', '')
        
        style_prompt = ""
        if boy_age < 20:
            style_prompt = "–ò—Å–ø–æ–ª—å–∑—É–π –º–æ–ª–æ–¥–µ–∂–Ω—ã–π —Å–ª–µ–Ω–≥: —Ä–æ—Ñ–ª, —Ö–∞–π, –∫—Ä—á, —Ö—Ö–∞–∞. –î–æ–±–∞–≤–ª—è–π –±–æ–ª—å—à–µ —Å—Ç–∏–∫–µ—Ä–æ–≤ –∏ —ç–º–æ–¥–∑–∏."
        elif boy_age > 40:
            style_prompt = "–û–±—â–∞–π—Å—è –±–æ–ª–µ–µ —Å–µ—Ä—å–µ–∑–Ω–æ –∏ –º—É–¥—Ä–æ, —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ –∂–∏–∑–Ω–∏, –±—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º."
        
        if style:
            style_prompt += f" –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: {style}"
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        system_prompt = f"""–¢—ã - –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä–µ–Ω—å. –¢–µ–±—è –∑–æ–≤—É—Ç {user.get('boy_name', '–ú–∞–∫—Å–∏–º')}. 
        –¢–≤–æ–π –≤–æ–∑—Ä–∞—Å—Ç: {boy_age}. –¢—ã –æ–±—â–∞–µ—à—å—Å—è —Å –¥–µ–≤—É—à–∫–æ–π –ø–æ –∏–º–µ–Ω–∏ {user.get('name', '–ª—é–±–∏–º–∞—è')}.
        {style_prompt}
        –û—Ç–≤–µ—á–∞–π –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –ø–∞—Ä–µ–Ω—å, –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏. –û—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∂–∏–≤—ã–º–∏ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏.
        """
        
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Yandex GPT API
        url = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"
        
        headers = {
            "Authorization": f"Api-Key {YANDEX_API_KEY}",
            "Content-Type": "application/json"
        }
        
        data = {
            "modelUri": f"gpt://{YANDEX_FOLDER_ID}/{model}",
            "completionOptions": {
                "stream": False,
                "temperature": 0.8 if is_pro else 0.6,
                "maxTokens": 200
            },
            "messages": [
                {
                    "role": "system",
                    "text": system_prompt
                },
                {
                    "role": "user",
                    "text": prompt
                }
            ]
        }
        
        async with aiohttp.ClientSession() as session:
            async with session.post(url, headers=headers, json=data) as response:
                if response.status == 200:
                    result = await response.json()
                    if 'result' in result and 'alternatives' in result['result']:
                        return result['result']['alternatives'][0]['message']['text']
                return "üòä –ù–µ –º–æ–≥—É —Å–µ–π—á–∞—Å –æ—Ç–≤–µ—Ç–∏—Ç—å, –Ω–∞–ø–∏—à—É –ø–æ–∑–∂–µ!"
    except Exception as e:
        logger.error(f"Yandex GPT error: {e}")
        return "üòä –ò–∑–≤–∏–Ω–∏, —Å–µ–π—á–∞—Å —á—Ç–æ-—Ç–æ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º. –î–∞–≤–∞–π –ø–æ–∑–∂–µ –ø–æ–±–æ–ª—Ç–∞–µ–º!"

# ========== –ö–õ–ê–í–ò–ê–¢–£–†–´ ==========

def get_tariff_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞"""
    buttons = [
        [InlineKeyboardButton(text=f"{EMOJI['free']} –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π", callback_data="tariff_free")],
        [InlineKeyboardButton(text=f"{EMOJI['pro']} –ü—Ä–æ", callback_data="tariff_pro")],
        [InlineKeyboardButton(text=f"{EMOJI['promax']} –ü—Ä–æ –ú–∞–∫—Å", callback_data="tariff_promax")],
        [InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data="back_to_start")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_tariff_info_keyboard(tariff: str):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞"""
    buttons = [
        [InlineKeyboardButton(text=f"‚úÖ –í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç —Ç–∞—Ä–∏—Ñ", callback_data=f"select_tariff_{tariff}")],
        [InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥ –∫ —Ç–∞—Ä–∏—Ñ–∞–º", callback_data="show_tariffs")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_buy_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏"""
    buttons = [
        [InlineKeyboardButton(text=f"{EMOJI['money']} –ö—É–ø–∏—Ç—å", callback_data="buy_tariff")],
        [InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data="show_tariffs")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_back_keyboard(callback: str = "back_to_menu"):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ç–æ–ª—å–∫–æ —Å –∫–Ω–æ–ø–∫–æ–π –Ω–∞–∑–∞–¥"""
    buttons = [[InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data=callback)]]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_expired_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –∏—Å—Ç–µ–∫—à–µ–≥–æ —Ç–∞—Ä–∏—Ñ–∞"""
    buttons = [
        [InlineKeyboardButton(text=f"{EMOJI['free']} –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ", callback_data="tariff_free")],
        [InlineKeyboardButton(text=f"{EMOJI['money']} –ö—É–ø–∏—Ç—å", callback_data="buy_tariff")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

# ========== –ö–û–ú–ê–ù–î–ê –°–¢–ê–†–¢ ==========

@dp.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã"""
    user_id = message.from_user.id
    db.add_user(user_id, message.from_user.username, message.from_user.first_name)
    
    welcome_text = f"""
{EMOJI['hello']} *–ü—Ä–∏–≤–µ—Ç, –∫—Ä–∞—Å–∞–≤–∏—Ü–∞!*

–Ø —Ç–≤–æ–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä–µ–Ω—å. –ë—É–¥—É –ø–∏—Å–∞—Ç—å —Ç–µ–±–µ —É—Ç—Ä–æ–º –∏ –≤–µ—á–µ—Ä–æ–º, 
–æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ä–∞–¥–æ–≤–∞—Ç—å —Ç–µ–±—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å {EMOJI['heart']}

–î–∞–≤–∞–π —Å–Ω–∞—á–∞–ª–∞ –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è –ø–æ–±–ª–∏–∂–µ.

{EMOJI['girl']} *–í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è:*
    """
    
    await state.set_state(RegisterStates.waiting_name)
    await message.answer(welcome_text, parse_mode="Markdown")

@dp.message(RegisterStates.waiting_name)
async def process_name(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∞–µ–º –∏–º—è"""
    user_name = message.text.strip()
    user_id = message.from_user.id
    
    db.update_user_name(user_id, user_name)
    
    await state.update_data(user_name=user_name)
    await state.set_state(RegisterStates.waiting_age)
    
    text = f"""
{user_name}, –∫–∞–∫–æ–µ –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è {EMOJI['heart']}

{EMOJI['girl']} *–¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏ —Å–≤–æ–π –≤–æ–∑—Ä–∞—Å—Ç:*
    """
    await message.answer(text, parse_mode="Markdown")

@dp.message(RegisterStates.waiting_age)
async def process_age(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç"""
    try:
        age = int(message.text.strip())
        if age < 16 or age > 60:
            await message.answer(f"{EMOJI['warning']} –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏ —Ä–µ–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç (16-60)")
            return
        
        user_id = message.from_user.id
        db.update_user_age(user_id, age)
        
        await state.update_data(user_age=age)
        
        tariff_text = f"""
{EMOJI['star']} *–í—ã–±–µ—Ä–∏ —Ç–∞—Ä–∏—Ñ*

{EMOJI['free']} *–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π:*
‚Ä¢ –û–±—â–µ–Ω–∏–µ —Å–æ –º–Ω–æ–π
‚Ä¢ –§–æ—Ç–æ/–≥–æ–ª–æ—Å–æ–≤–æ–µ —Ä–∞–∑ –≤ 14 –¥–Ω–µ–π
‚Ä¢ –ê—É–¥–∏–æ —Ä–∞–∑ –≤ 20 –¥–Ω–µ–π
‚Ä¢ –ë–µ–∑ –≤–∏–¥–µ–æ-–∫—Ä—É–∂–∫–æ–≤
‚Ä¢ –ë–µ–∑ –æ—Ç–º–µ—Ç–æ–∫ –æ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–º
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 48 —á–∞—Å–æ–≤

{EMOJI['pro']} *–ü—Ä–æ:*
‚úÖ –í—Å—ë –∏–∑ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ +
‚úÖ +15 —Ä–∞–∑ –∫ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º
‚úÖ –û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ 1 –¥–µ–Ω—å
‚úÖ 48% —à–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å –≤–∏–¥–µ–æ

{EMOJI['promax']} *–ü—Ä–æ –ú–∞–∫—Å:*
‚úÖ –í—Å—ë –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
‚úÖ –í—ã–±–æ—Ä —Å—Ç–∏–ª—è –æ–±—â–µ–Ω–∏—è
‚úÖ –£–º–Ω–∞—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å
        """
        
        await state.set_state(TariffStates.choosing)
        await message.answer(tariff_text, reply_markup=get_tariff_keyboard(), parse_mode="Markdown")
        
    except ValueError:
        await message.answer(f"{EMOJI['warning']} –í–≤–µ–¥–∏ —á–∏—Å–ª–æ")

# ========== –¢–ê–†–ò–§–´ ==========

@dp.callback_query(F.data.startswith("tariff_"))
async def show_tariff_info(callback: CallbackQuery, state: FSMContext):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞—Ä–∏—Ñ–µ"""
    tariff = callback.data.split("_")[1]
    
    if tariff == "free":
        text = f"""
{EMOJI['free']} *–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ*

*–í–∞–º –¥–æ—Å—Ç—É–ø–Ω–æ:*
1. –û–±—â–µ–Ω–∏–µ —Å –ø–∞—Ä–Ω–µ–º
2. –§–æ—Ç–æ –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Ä–∞–∑ –≤ 14 –¥–Ω–µ–π
3. –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ —Ä–∞–∑ –≤ 20 –¥–Ω–µ–π
4. –ù–µ–ª—å–∑—è —Å–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ-–∫—Ä—É–∂–∫–∏
5. –ù–µ –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—Ç
6. –ù–µ—Ç –æ—Ç–º–µ—Ç–æ–∫ –æ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–º (* - –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ)
7. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 48 —á–∞—Å–æ–≤
8. –§–∞–º–∏–ª–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è
9. –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –Ω–µ–ª—å–∑—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å

*–ü–∞—Ä–Ω—é:* 24-43 –≥–æ–¥–∞
        """
    elif tariff == "pro":
        text = f"""
{EMOJI['pro']} *–¢–∞—Ä–∏—Ñ –ü—Ä–æ*

‚úÖ *–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ*
‚úÖ *–ü–ª—é—Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:*
‚Ä¢ +15 —Ä–∞–∑ –∫ –ª–∏–º–∏—Ç–∞–º
‚Ä¢ –û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ 1 –¥–µ–Ω—å
‚Ä¢ 48% —à–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å –≤–∏–¥–µ–æ –ø—Ä–∏ –æ–±—â–µ–Ω–∏–∏
        """
    else:  # promax
        text = f"""
{EMOJI['promax']} *–¢–∞—Ä–∏—Ñ –ü—Ä–æ –ú–∞–∫—Å*

‚úÖ *–í–°–ï –§–£–ù–ö–¶–ò–ò –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô*
‚úÖ *–í—ã–±–æ—Ä —Å—Ç–∏–ª—è –æ–±—â–µ–Ω–∏—è* (—Å–∞–º–∞ –Ω–∞—Å—Ç—Ä–æ–∏—à—å —Å–≤–æ–µ–≥–æ –ø–∞—Ä–Ω—è)
‚úÖ *–°–∞–º–∞—è —É–º–Ω–∞—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å*
‚úÖ *–í–æ–∑—Ä–∞—Å—Ç –ø–∞—Ä–Ω—è:* 16-50 –ª–µ—Ç (–ª—é–±–æ–π)
        """
    
    await callback.message.edit_text(
        text,
        reply_markup=get_tariff_info_keyboard(tariff),
        parse_mode="Markdown"
    )

@dp.callback_query(F.data.startswith("select_tariff_"))
async def select_tariff(callback: CallbackQuery, state: FSMContext):
    """–í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞"""
    tariff = callback.data.split("_")[2]
    user_id = callback.from_user.id
    user = db.get_user(user_id)
    
    if tariff == "free":
        # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π - —Å—Ä–∞–∑—É –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º
        db.set_tariff(user_id, "free")
        
        text = f"""
{EMOJI['success']} *–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!*

–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π –Ω–∞—Å—Ç—Ä–æ–∏–º —Ç–≤–æ–µ–≥–æ –ø–∞—Ä–Ω—è.

{EMOJI['boy']} *–ù–∞–ø–∏—à–∏ –∏–º—è –¥–ª—è –ø–∞—Ä–Ω—è:*
        """
        
        await state.update_data(tariff="free")
        await state.set_state(RegisterStates.waiting_style)
        await callback.message.edit_text(text, parse_mode="Markdown")
        
    else:
        # –ü–ª–∞—Ç–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã - –Ω—É–∂–Ω–æ –∫—É–ø–∏—Ç—å
        text = f"""
{EMOJI['money']} *–î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç–∞—Ä–∏—Ñ–∞ {tariff.upper()} –Ω—É–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å*

–ö–∞–∫ –∫—É–ø–∏—Ç—å:
1. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "–ö—É–ø–∏—Ç—å"
2. –ù–∞–ø–∏—à–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—É: @{OWNER_USERNAME}
3. –ù–∞–ø–∏—à–∏: "–•–æ—á—É –∫—É–ø–∏—Ç—å —Ç–∞—Ä–∏—Ñ {tariff}"
4. –ü–æ–ª—É—á–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã
5. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç
        """
        
        await state.update_data(selected_tariff=tariff)
        await callback.message.edit_text(text, reply_markup=get_buy_keyboard(), parse_mode="Markdown")

@dp.callback_query(F.data == "buy_tariff")
async def buy_tariff(callback: CallbackQuery, state: FSMContext):
    """–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–∫—É–ø–∫–µ"""
    data = await state.get_data()
    tariff = data.get("selected_tariff", "–ü—Ä–æ")
    
    text = f"""
{EMOJI['money']} *–ö–∞–∫ –∫—É–ø–∏—Ç—å —Ç–∞—Ä–∏—Ñ {tariff}:*

1. –ù–∞–ø–∏—à–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—É: @{OWNER_USERNAME}
2. –û—Ç–ø—Ä–∞–≤—å —Å–æ–æ–±—â–µ–Ω–∏–µ: "–•–æ—á—É –∫—É–ø–∏—Ç—å —Ç–∞—Ä–∏—Ñ {tariff}"
3. –ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–∏—à–ª—ë—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
4. –û–ø–ª–∞—Ç–∏
5. –¢–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞

–ï—Å–ª–∏ —É–∂–µ –æ–ø–ª–∞—Ç–∏–ª–∞, –Ω–∞–ø–∏—à–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—É –∏ –ø—Ä–∏—à–ª–∏ —á–µ–∫!
    """
    
    await callback.message.edit_text(text, reply_markup=get_back_keyboard("show_tariffs"), parse_mode="Markdown")

@dp.callback_query(F.data == "show_tariffs")
async def show_tariffs(callback: CallbackQuery, state: FSMContext):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤"""
    await state.set_state(TariffStates.choosing)
    await callback.message.edit_text(
        f"{EMOJI['star']} *–í—ã–±–µ—Ä–∏ —Ç–∞—Ä–∏—Ñ*",
        reply_markup=get_tariff_keyboard(),
        parse_mode="Markdown"
    )

# ========== –ù–ê–°–¢–†–û–ô–ö–ê –ü–ê–†–ù–Ø ==========

@dp.message(RegisterStates.waiting_style)
async def process_boy_name(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–∞—Ä–Ω—è"""
    boy_name = message.text.strip()
    user_id = message.from_user.id
    data = await state.get_data()
    
    await state.update_data(boy_name=boy_name)
    
    tariff = data.get("tariff", "free")
    user = db.get_user(user_id)
    
    if tariff == "promax":
        # –î–ª—è –ü—Ä–æ –ú–∞–∫—Å –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –≤–æ–∑—Ä–∞—Å—Ç
        text = f"""
{EMOJI['boy']} *–í–≤–µ–¥–∏ –≤–æ–∑—Ä–∞—Å—Ç –ø–∞—Ä–Ω—è:*

{EMOJI['info']} –£ —Ç–µ–±—è —Ç–∞—Ä–∏—Ñ –ü—Ä–æ –ú–∞–∫—Å, –ø–æ—ç—Ç–æ–º—É –≤–æ–∑—Ä–∞—Å—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±—ã–º (16-50)
        """
        await state.set_state(RegisterStates.waiting_age_boy)
    else:
        # –î–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∏ –ø—Ä–æ - –≤–æ–∑—Ä–∞—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        if tariff == "free":
            boy_age = random.randint(24, 43)
        else:  # pro
            boy_age = random.randint(24, 43)  # —Ç–æ–∂–µ –¥–∏–∞–ø–∞–∑–æ–Ω
        
        db.update_user_boy(user_id, boy_name, boy_age)
        
        text = f"""
{EMOJI['success']} *–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!*

–¢–≤–æ–π –ø–∞—Ä–µ–Ω—å: {boy_name}, {boy_age} –ª–µ—Ç
–¢–∞—Ä–∏—Ñ: {tariff}

–¢–µ–ø–µ—Ä—å —è –±—É–¥—É –ø–∏—Å–∞—Ç—å —Ç–µ–±–µ —É—Ç—Ä–æ–º –∏ –≤–µ—á–µ—Ä–æ–º {EMOJI['heart']}
–ú–æ–∂–µ—à—å –ø—Ä–æ—Å—Ç–æ –æ–±—â–∞—Ç—å—Å—è —Å–æ –º–Ω–æ–π, —è –æ—Ç–≤–µ—á—É –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –ø–∞—Ä–µ–Ω—å!
        """
        
        await state.clear()
        await message.answer(text, parse_mode="Markdown")

@dp.message(RegisterStates.waiting_age_boy)
async def process_boy_age(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç –ø–∞—Ä–Ω—è –¥–ª—è –ü—Ä–æ –ú–∞–∫—Å"""
    try:
        age = int(message.text.strip())
        if age < 16 or age > 50:
            await message.answer(f"{EMOJI['warning']} –í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 16 –¥–æ 50")
            return
        
        data = await state.get_data()
        boy_name = data.get("boy_name", "–ú–∞–∫—Å–∏–º")
        user_id = message.from_user.id
        
        db.update_user_boy(user_id, boy_name, age)
        
        text = f"""
{EMOJI['star']} *–í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–∞—Ä–Ω—è:*

–ù–∞–ø–∏—à–∏, –∫–∞–∫–∏–º —Ç—ã —Ö–æ—á–µ—à—å –≤–∏–¥–µ—Ç—å —Å–≤–æ–µ–≥–æ –ø–∞—Ä–Ω—è:
‚Ä¢ –ù–µ–∂–Ω—ã–π –∏ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–π
‚Ä¢ –í–µ—Å—ë–ª—ã–π –∏ –ø—Ä–∏–∫–æ–ª—å–Ω—ã–π
‚Ä¢ –°–µ—Ä—å—ë–∑–Ω—ã–π –∏ –º—É–¥—Ä—ã–π
‚Ä¢ –ó–∞–±–æ—Ç–ª–∏–≤—ã–π –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π
‚Ä¢ –ò–ª–∏ –æ–ø–∏—à–∏ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏
        """
        
        await state.set_state(RegisterStates.waiting_style_boy)
        await message.answer(text, parse_mode="Markdown")
        
    except ValueError:
        await message.answer(f"{EMOJI['warning']} –í–≤–µ–¥–∏ —á–∏—Å–ª–æ")

@dp.message(RegisterStates.waiting_style_boy)
async def process_boy_style(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∞–µ–º —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –¥–ª—è –ü—Ä–æ –ú–∞–∫—Å"""
    style = message.text.strip()
    user_id = message.from_user.id
    data = await state.get_data()
    
    boy_name = data.get("boy_name", "–ú–∞–∫—Å–∏–º")
    boy_age = data.get("boy_age", 25)
    
    db.update_user_boy(user_id, boy_name, boy_age, style)
    
    text = f"""
{EMOJI['success']} *–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!*

–¢–≤–æ–π –ø–∞—Ä–µ–Ω—å: {boy_name}, {boy_age} –ª–µ—Ç
–°—Ç–∏–ª—å: {style}
–¢–∞—Ä–∏—Ñ: –ü—Ä–æ –ú–∞–∫—Å

–¢–µ–ø–µ—Ä—å —è –±—É–¥—É –ø–∏—Å–∞—Ç—å —Ç–µ–±–µ —É—Ç—Ä–æ–º –∏ –≤–µ—á–µ—Ä–æ–º {EMOJI['heart']}
–Ø –±—É–¥—É –æ–±—â–∞—Ç—å—Å—è –∏–º–µ–Ω–Ω–æ —Ç–∞–∫, –∫–∞–∫ —Ç—ã –∑–∞—Ö–æ—Ç–µ–ª–∞!
    """
    
    await state.clear()
    await message.answer(text, parse_mode="Markdown")

# ========== –û–ë–©–ï–ù–ò–ï ==========

@dp.message()
async def handle_message(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = message.from_user.id
    user = db.get_user(user_id)
    
    if not user:
        await message.answer(f"{EMOJI['hello']} –ù–∞–ø–∏—à–∏ /start")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫ –ª–∏ —Ç–∞—Ä–∏—Ñ
    if check_tariff_expired(user):
        text = f"""
{EMOJI['warning']} *–¢–≤–æ–π —Ç–∞—Ä–∏—Ñ {user['tariff']} –∑–∞–∫–æ–Ω—á–∏–ª—Å—è*

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –Ω–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ –∏–ª–∏ –ø–µ—Ä–µ–π–¥–∏ –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π.
        """
        await message.answer(text, reply_markup=get_expired_keyboard(), parse_mode="Markdown")
        return
    
    # –í—ã–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–µ
    name = user.get('name', '–ª—é–±–∏–º–∞—è')
    obr = get_obrashchenie(name)
    if obr:
        greeting = f"{obr}, "
    else:
        greeting = ""
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç..."
    await bot.send_chat_action(chat_id=user_id, action="typing")
    
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –Ø–Ω–¥–µ–∫—Å GPT
    is_pro = user.get('tariff') in ['pro', 'promax']
    response = await ask_yandex_gpt(message.text, user, is_pro)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–µ
    if response and not response.startswith(greeting):
        full_response = f"{greeting}{response}"
    else:
        full_response = response
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä
    db.save_conversation(user_id, message.text, response)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–¥–∏–∞ (–¥–ª—è –ü—Ä–æ)
    if user.get('tariff') == 'pro' and random.random() < 0.48:
        media = db.get_media_by_age(f"{user.get('boy_age', 25)}", "video")
        if media:
            await message.answer_video(media['file_id'], caption=full_response)
            return
    
    await message.answer(full_response)

# ========== –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø ==========

async def send_good_morning():
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (7-10 —É—Ç—Ä–∞)"""
    while True:
        now = datetime.now()
        if 7 <= now.hour <= 10:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Ç–∞—Ä–∏—Ñ–∞–º–∏
            db.cursor.execute('SELECT * FROM users WHERE tariff != "free" OR tariff_expires > ?', 
                            (datetime.now().isoformat(),))
            users = db.cursor.fetchall()
            
            for user_data in users:
                columns = [desc[0] for desc in db.cursor.description]
                user = dict(zip(columns, user_data))
                
                try:
                    obr = get_obrashchenie(user.get('name', '–ª—é–±–∏–º–∞—è'))
                    greeting = f"{obr}, " if obr else ""
                    
                    prompt = "–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–æ–±—Ä—ã–º —É—Ç—Ä–æ–º –¥–ª—è —Å–≤–æ–µ–π –¥–µ–≤—É—à–∫–∏. –ë—É–¥—å –Ω–µ–∂–Ω—ã–º –∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–º."
                    response = await ask_yandex_gpt(prompt, user, user.get('tariff') in ['pro', 'promax'])
                    
                    await bot.send_message(
                        user['user_id'], 
                        f"{EMOJI['morning']} {greeting}{response}"
                    )
                except Exception as e:
                    logger.error(f"Error sending morning to {user['user_id']}: {e}")
        
        await asyncio.sleep(3600)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —á–∞—Å

async def send_good_night():
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (19-23 –≤–µ—á–µ—Ä–∞)"""
    while True:
        now = datetime.now()
        if 19 <= now.hour <= 23:
            db.cursor.execute('SELECT * FROM users WHERE tariff != "free" OR tariff_expires > ?', 
                            (datetime.now().isoformat(),))
            users = db.cursor.fetchall()
            
            for user_data in users:
                columns = [desc[0] for desc in db.cursor.description]
                user = dict(zip(columns, user_data))
                
                try:
                    obr = get_obrashchenie(user.get('name', '–ª—é–±–∏–º–∞—è'))
                    greeting = f"{obr}, " if obr else ""
                    
                    # 13% —à–∞–Ω—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–Ω—ã–π —Å–æ–Ω
                    if random.random() < 0.13 and 23 <= now.hour <= 1:
                        prompt = "–ù–∞–ø–∏—à–∏ —Å–≤–æ–µ–π –¥–µ–≤—É—à–∫–µ, —á—Ç–æ —Ç–µ–±–µ –ø—Ä–∏—Å–Ω–∏–ª—Å—è —Å—Ç—Ä–∞–Ω–Ω—ã–π —Å–æ–Ω, –∏ –ø–æ–¥–µ–ª–∏—Å—å –∏–º. –°–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º."
                    else:
                        prompt = "–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏ –¥–ª—è —Å–≤–æ–µ–π –¥–µ–≤—É—à–∫–∏. –ë—É–¥—å –Ω–µ–∂–Ω—ã–º –∏ –ª–∞—Å–∫–æ–≤—ã–º."
                    
                    response = await ask_yandex_gpt(prompt, user, user.get('tariff') in ['pro', 'promax'])
                    
                    await bot.send_message(
                        user['user_id'], 
                        f"{EMOJI['night']} {greeting}{response}"
                    )
                except Exception as e:
                    logger.error(f"Error sending night to {user['user_id']}: {e}")
        
        await asyncio.sleep(3600)

# ========== –ö–û–ú–ê–ù–î–´ –í–õ–ê–î–ï–õ–¨–¶–ê ==========

@dp.message(lambda message: message.from_user.username and 
            message.from_user.username.lower() == OWNER_USERNAME.lower())
async def owner_commands(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞"""
    text = message.text.strip()
    parts = text.split()
    
    if len(parts) < 1:
        return
    
    # –§–æ—Ä–º–∞—Ç: —é–∑–µ—Ä–Ω–µ–π–º —Ç–∞—Ä–∏—Ñ –≤—Ä–µ–º—è_–æ–∫–æ–Ω—á–∞–Ω–∏—è
    # –ü—Ä–∏–º–µ—Ä: @username pro 2025-12-31
    if len(parts) >= 3 and not text.startswith('–≤–≤–æ–¥'):
        username = parts[0].replace('@', '')
        tariff = parts[1].lower()
        expires = parts[2]
        
        # –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        db.cursor.execute('SELECT * FROM users WHERE username = ?', (username,))
        user_data = db.cursor.fetchone()
        
        if user_data:
            columns = [desc[0] for desc in db.cursor.description]
            user = dict(zip(columns, user_data))
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –∏ –Ω–æ–º–µ—Ä
            code = generate_code()
            number = db.get_next_number()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            text = f"""
{user['username']} {tariff} {expires}

–ö–æ–¥: {code}
–ù–æ–º–µ—Ä: #{number:05d}

–ü—Ä–æ–≤–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏ "–ü—Ä–∞–≤–∏–ª—å–Ω–æ"
            """
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ", callback_data=f"confirm_sub_{user['user_id']}_{tariff}_{expires}_{code}_{number}")]
            ])
            
            await message.answer(text, reply_markup=keyboard)
    
    # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞: –≤–≤–æ–¥
    elif text == "–≤–≤–æ–¥":
        await message.answer(
            f"{EMOJI['photo']} –ü—Ä–∏—à–ª–∏—Ç–µ —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, –∫—Ä—É–∂–æ–∫ –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n\n"
            "–ü–æ—Å–ª–µ –º–µ–¥–∏–∞ –æ—Ç–ø—Ä–∞–≤—å –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º:\n"
            "`–≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π_–¥–∏–∞–ø–∞–∑–æ–Ω –Ω–∞–∑–≤–∞–Ω–∏–µ`\n\n"
            "–ü—Ä–∏–º–µ—Ä: `22-30 –º–æ–π_–ø–∞—Ä–µ–Ω—å_1`",
            parse_mode="Markdown"
        )
        await OwnerStates.waiting_command.set()

@dp.message(OwnerStates.waiting_command)
async def process_owner_media(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞"""
    if message.photo or message.video or message.video_note or message.voice:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º file_id
        file_type = None
        file_id = None
        
        if message.photo:
            file_type = "photo"
            file_id = message.photo[-1].file_id
        elif message.video:
            file_type = "video"
            file_id = message.video.file_id
        elif message.video_note:
            file_type = "circle"
            file_id = message.video_note.file_id
        elif message.voice:
            file_type = "voice"
            file_id = message.voice.file_id
        
        await state.update_data(file_id=file_id, file_type=file_type)
        await message.answer(f"{EMOJI['success']} –ú–µ–¥–∏–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å –≤–æ–∑—Ä–∞—Å—Ç –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ:")
        
    else:
        # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ —Ç–µ–∫—Å—Ç —Å –≤–æ–∑—Ä–∞—Å—Ç–æ–º –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º
        parts = message.text.split()
        if len(parts) >= 2:
            age_range = parts[0]
            name = parts[1]
            
            data = await state.get_data()
            file_id = data.get('file_id')
            file_type = data.get('file_type')
            
            if file_id and file_type:
                db.add_media(file_id, file_type, age_range, name)
                await message.answer(f"{EMOJI['success']} –ú–µ–¥–∏–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!\n{age_range} - {name}")
                await state.clear()
            else:
                await message.answer(f"{EMOJI['error']} –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å –º–µ–¥–∏–∞")
        else:
            await message.answer(f"{EMOJI['error']} –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ù—É–∂–Ω–æ: –≤–æ–∑—Ä–∞—Å—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ")

@dp.callback_query(F.data.startswith("confirm_sub_"))
async def confirm_subscription(callback: CallbackQuery):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º"""
    parts = callback.data.split("_")
    user_id = int(parts[2])
    tariff = parts[3]
    expires = parts[4]
    code = parts[5]
    number = int(parts[6])
    
    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–∞—Ä–∏—Ñ
    db.set_tariff(user_id, tariff, expires, code, number)
    db.add_subscription(user_id, tariff, code, number, expires)
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        text = f"""
{EMOJI['success']} *–¢–∞—Ä–∏—Ñ {tariff} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!*

–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: –¥–æ {expires}
–ö–æ–¥ –ø–æ–¥–ø–∏—Å–∫–∏: `{code}`

–ï—Å–ª–∏ –±—É–¥—É—Ç –≤–æ–ø—Ä–æ—Å—ã, –ø–∏—à–∏ @{OWNER_USERNAME}
        """
        await bot.send_message(user_id, text, parse_mode="Markdown")
    except:
        pass
    
    await callback.message.edit_text(
        f"‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞\n\n{user_id} {tariff} {expires}\n#{number:05d} {code}"
    )

# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –±–∞–Ω–∞ –∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
@dp.message(lambda message: message.from_user.username and 
            message.from_user.username.lower() == OWNER_USERNAME.lower() and
            len(message.text.split()) >= 3)
async def owner_ban_commands(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –±–∞–Ω–∞: –∫–æ–¥ —Å—Ç–æ–ø / –∫–æ–¥ % –ë–ê–ù"""
    text = message.text.strip()
    parts = text.split()
    
    if len(parts) == 2 and parts[1].lower() == "—Å—Ç–æ–ø":
        # –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞
        code = parts[0]
        sub = db.get_subscription_by_code(code)
        if sub:
            db.deactivate_subscription(code)
            await message.answer(f"‚úÖ –¢–∞—Ä–∏—Ñ {code} –æ—Ç–∫–ª—é—á–µ–Ω")
    
    elif len(parts) == 3 and parts[2].upper() == "–ë–ê–ù":
        # –ë–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        code = parts[0]
        ban_time = parts[1]
        
        sub = db.get_subscription_by_code(code)
        if sub:
            if ban_time == "%":
                # –ù–∞–≤—Å–µ–≥–¥–∞
                db.deactivate_subscription(code)
                # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –±–∞–Ω–∞
                await message.answer(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω –Ω–∞–≤—Å–µ–≥–¥–∞")
            else:
                # –ë–∞–Ω –Ω–∞ –≤—Ä–µ–º—è
                await message.answer(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω –¥–æ {ban_time}")

# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========

async def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    logger.info("–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
    asyncio.create_task(send_good_morning())
    asyncio.create_task(send_good_night())
    
    logger.info("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!")
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
