import asyncio
import logging
import sqlite3
import json
import random
import string
import re
import time
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Tuple, Any, Set
from enum import Enum
from collections import defaultdict

from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import (
    Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton,
    ReplyKeyboardMarkup, KeyboardButton, ChatMemberUpdated, FSInputFile,
    ReplyKeyboardRemove
)
from aiogram.utils.keyboard import InlineKeyboardBuilder, ReplyKeyboardBuilder

# ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
TOKEN = "YOUR_BOT_TOKEN_HERE"
ADMIN_GROUP_ID = -1001234567890  # ID –≥—Ä—É–ø–ø—ã –∞–¥–º–∏–Ω–æ–≤ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞ —Å —Ç–µ–º–∞–º–∏)
CHANNEL_ID = "@your_channel"    # –ö–∞–Ω–∞–ª –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
OWNER_ID = 1234567890           # ID –≤–ª–∞–¥–µ–ª—å—Ü–∞ (Timyr2011)

bot = Bot(token=TOKEN)
dp = Dispatcher(storage=MemoryStorage())

# –≠–º–æ–¥–∑–∏ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
EMOJI = {
    "main": "üéÆ", "nft": "üéÅ", "stars": "‚≠ê", "premium": "üëë",
    "auction": "üî®", "reviews": "üìù", "support": "üÜò", "settings": "‚öôÔ∏è",
    "admin": "üë®‚Äçüíº", "back": "üîô", "success": "‚úÖ", "error": "‚ùå",
    "warning": "‚ö†Ô∏è", "info": "‚ÑπÔ∏è", "money": "üí∞", "time": "‚è∞",
    "user": "üë§", "lock": "üîí", "unlock": "üîì", "stats": "üìä",
    "stop": "üõë", "add": "‚ûï", "edit": "‚úèÔ∏è", "delete": "üóëÔ∏è",
    "search": "üîç", "filter": "üîß", "next": "‚ñ∂Ô∏è", "prev": "‚óÄÔ∏è",
    "home": "üè†", "cart": "üõí", "gift": "üéÅ", "fire": "üî•",
    "crown": "üëë", "star": "‚≠ê", "diamond": "üíé", "trophy": "üèÜ",
    "bell": "üîî", "check": "‚úîÔ∏è", "cancel": "‚ùå", "people": "üë•",
    "camera": "üì∑", "document": "üìÑ", "phone": "üì±", "email": "üìß"
}

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
auction_timers = {}  # –¢–∞–π–º–µ—Ä—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∞—É–∫—Ü–∏–æ–Ω–∞—Ö
active_auctions = {}  # –ê–∫—Ç–∏–≤–Ω—ã–µ –∞—É–∫—Ü–∏–æ–Ω—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
auction_bids = defaultdict(list)  # –°—Ç–∞–≤–∫–∏ –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω–∞—Ö

# ========== –°–û–°–¢–û–Ø–ù–ò–Ø FSM ==========
class UserStates(StatesGroup):
    waiting_subscription = State()
    main_menu = State()
    buy_nft = State()
    buy_stars = State()
    buy_premium = State()
    auction_menu = State()
    auction_participate = State()
    auction_bidding = State()
    reviews = State()
    support = State()
    settings = State()
    waiting_captcha = State()
    waiting_promo = State()

class AdminStates(StatesGroup):
    admin_menu = State()
    set_star_price = State()
    add_nft = State()
    add_nft_name = State()
    add_nft_price = State()
    add_nft_link = State()
    confirm_nft = State()
    statistics = State()
    captcha_settings = State()
    stop_bot = State()
    ban_user = State()
    spam_ban = State()
    add_staff = State()
    auction_settings = State()
    edit_auction = State()
    auction_manage = State()
    set_auction_name = State()
    set_auction_time = State()
    set_auction_type = State()
    set_auction_price = State()
    set_promo_code = State()
    confirm_auction = State()
    set_auction_prize = State()
    set_auction_photo = State()
    set_auction_min_price = State()
    stream_auction = State()

class SupportStates(StatesGroup):
    waiting_reason = State()
    waiting_message = State()
    processing = State()

# ========== –ë–ê–ó–ê –î–ê–ù–ù–´–• ==========
class Database:
    def __init__(self, db_path="bot_database.db"):
        self.conn = sqlite3.connect(db_path, check_same_thread=False)
        self.cursor = self.conn.cursor()
        self.init_db()
    
    def init_db(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü"""
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                first_name TEXT,
                last_name TEXT,
                subscribed INTEGER DEFAULT 0,
                banned INTEGER DEFAULT 0,
                spam_count INTEGER DEFAULT 0,
                last_message_time TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –ü–µ—Ä—Å–æ–Ω–∞–ª
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS staff (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                role TEXT, -- 'owner', 'admin', 'manager'
                added_by INTEGER,
                added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # NFT —Ç–æ–≤–∞—Ä—ã
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS nft_items (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                price REAL NOT NULL,
                link TEXT NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                sort_order INTEGER DEFAULT 0,
                is_active INTEGER DEFAULT 1
            )
        ''')
        
        # –ó–∞–∫–∞–∑—ã/–ø–æ–¥–¥–µ—Ä–∂–∫–∞
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS orders (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                order_type TEXT NOT NULL, -- 'nft', 'stars', 'premium', 'auction', 'support', 'review'
                details TEXT,
                status TEXT DEFAULT 'a', -- a,b,d,s,z,g,v
                admin_id INTEGER,
                admin_username TEXT,
                price REAL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                thread_id INTEGER,
                forum_topic_id INTEGER,
                FOREIGN KEY (user_id) REFERENCES users(user_id)
            )
        ''')
        
        # –ê—É–∫—Ü–∏–æ–Ω—ã
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS auctions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT,
                start_time TIMESTAMP,
                type TEXT,
                entry_price REAL,
                promo_code TEXT,
                status TEXT DEFAULT 'pending',
                current_item TEXT,
                current_price REAL DEFAULT 0,
                current_photo TEXT,
                winner_id INTEGER,
                notified_5min INTEGER DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∞—É–∫—Ü–∏–æ–Ω–∞
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS auction_participants (
                auction_id INTEGER,
                user_id INTEGER,
                username TEXT,
                paid INTEGER DEFAULT 0,
                notified INTEGER DEFAULT 0,
                joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (auction_id, user_id)
            )
        ''')
        
        # –°—Ç–∞–≤–∫–∏ –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω–µ
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS auction_bids (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                auction_id INTEGER,
                user_id INTEGER,
                username TEXT,
                bid_amount REAL,
                bid_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –¢–æ–≤–∞—Ä—ã –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω–µ
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS auction_items (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                auction_id INTEGER,
                name TEXT,
                min_price REAL,
                photo_id TEXT,
                status TEXT DEFAULT 'pending', -- pending, active, sold
                winner_id INTEGER,
                final_price REAL,
                sold_at TIMESTAMP
            )
        ''')
        
        # –¶–µ–Ω—ã –Ω–∞ –∑–≤–µ–∑–¥—ã
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS star_prices (
                id INTEGER PRIMARY KEY,
                stars INTEGER,
                price REAL,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –¶–µ–Ω—ã –Ω–∞ –ø—Ä–µ–º–∏—É–º
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS premium_prices (
                id INTEGER PRIMARY KEY,
                type TEXT, -- 'no_login', 'with_login'
                period TEXT,
                price REAL,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS settings (
                key TEXT PRIMARY KEY,
                value TEXT,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –ü—Ä–æ–º–æ–∫–æ–¥—ã
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS promo_codes (
                code TEXT PRIMARY KEY,
                discount_percent INTEGER DEFAULT 0,
                discount_amount REAL DEFAULT 0,
                valid_until TIMESTAMP,
                uses_left INTEGER DEFAULT 1,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS statistics (
                date DATE PRIMARY KEY,
                new_users INTEGER DEFAULT 0,
                orders INTEGER DEFAULT 0,
                revenue REAL DEFAULT 0,
                nft_sold INTEGER DEFAULT 0,
                stars_sold INTEGER DEFAULT 0,
                premium_sold INTEGER DEFAULT 0
            )
        ''')
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ü–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        self.init_default_prices()
        self.conn.commit()
    
    def init_default_prices(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ü–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        # –ó–≤–µ–∑–¥—ã
        star_defaults = [
            (1, 50, 99), (2, 100, 199), (3, 300, 499),
            (4, 500, 999), (5, 1000, 1999), (6, 5000, 4299)
        ]
        for sid, stars, price in star_defaults:
            self.cursor.execute('''
                INSERT OR IGNORE INTO star_prices (id, stars, price) VALUES (?, ?, ?)
            ''', (sid, stars, price))
        
        # –ü—Ä–µ–º–∏—É–º –±–µ–∑ –≤—Ö–æ–¥–∞
        premium_no_login = [
            (1, 'no_login', '1 –º–µ—Å—è—Ü', 6.2),
            (2, 'no_login', '3 –º–µ—Å—è—Ü–∞', 10),
            (3, 'no_login', '6 –º–µ—Å—è—Ü–µ–≤', 18),
            (4, 'no_login', '1 –≥–æ–¥', 35)
        ]
        
        # –ü—Ä–µ–º–∏—É–º —Å –≤—Ö–æ–¥–æ–º
        premium_with_login = [
            (5, 'with_login', '1 –º–µ—Å—è—Ü', 8),
            (6, 'with_login', '3 –º–µ—Å—è—Ü–∞', 15),
            (7, 'with_login', '6 –º–µ—Å—è—Ü–µ–≤', 28),
            (8, 'with_login', '1 –≥–æ–¥', 50),
            (9, 'with_login', '2 –≥–æ–¥–∞', 95)
        ]
        
        for pid, ptype, period, price in premium_no_login + premium_with_login:
            self.cursor.execute('''
                INSERT OR IGNORE INTO premium_prices (id, type, period, price) VALUES (?, ?, ?, ?)
            ''', (pid, ptype, period, price))
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        default_settings = [
            ('captcha_enabled', '1'),
            ('bot_active', '1'),
            ('spam_limit', '5'),
            ('spam_window', '10'),
            ('auction_notify_5min', '1')
        ]
        for key, value in default_settings:
            self.cursor.execute('''
                INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)
            ''', (key, value))
    
    # –ú–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    def add_user(self, user_id: int, username: str, first_name: str, last_name: str = ""):
        self.cursor.execute('''
            INSERT OR REPLACE INTO users (user_id, username, first_name, last_name, created_at)
            VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)
        ''', (user_id, username, first_name, last_name))
        self.conn.commit()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        today = datetime.now().date()
        self.cursor.execute('''
            INSERT OR IGNORE INTO statistics (date) VALUES (?)
        ''', (today,))
        self.cursor.execute('''
            UPDATE statistics SET new_users = new_users + 1 WHERE date = ?
        ''', (today,))
        self.conn.commit()
    
    def check_subscription(self, user_id: int) -> bool:
        self.cursor.execute('SELECT subscribed FROM users WHERE user_id = ?', (user_id,))
        result = self.cursor.fetchone()
        return result[0] == 1 if result else False
    
    def update_subscription(self, user_id: int, status: bool):
        self.cursor.execute('UPDATE users SET subscribed = ? WHERE user_id = ?', (1 if status else 0, user_id))
        self.conn.commit()
    
    def is_banned(self, user_id: int) -> bool:
        self.cursor.execute('SELECT banned FROM users WHERE user_id = ?', (user_id,))
        result = self.cursor.fetchone()
        return result[0] == 1 if result else False
    
    def ban_user(self, user_id: int):
        self.cursor.execute('UPDATE users SET banned = 1 WHERE user_id = ?', (user_id,))
        self.conn.commit()
    
    def unban_user(self, user_id: int):
        self.cursor.execute('UPDATE users SET banned = 0 WHERE user_id = ?', (user_id,))
        self.conn.commit()
    
    def update_spam_count(self, user_id: int):
        self.cursor.execute('''
            UPDATE users 
            SET spam_count = spam_count + 1, last_message_time = CURRENT_TIMESTAMP 
            WHERE user_id = ?
        ''', (user_id,))
        self.conn.commit()
    
    def reset_spam_count(self, user_id: int):
        self.cursor.execute('UPDATE users SET spam_count = 0 WHERE user_id = ?', (user_id,))
        self.conn.commit()
    
    # –ú–µ—Ç–æ–¥—ã –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞
    def is_owner(self, user_id: int) -> bool:
        self.cursor.execute('SELECT role FROM staff WHERE user_id = ?', (user_id,))
        result = self.cursor.fetchone()
        return result and result[0] == 'owner'
    
    def is_admin(self, user_id: int) -> bool:
        self.cursor.execute('SELECT role FROM staff WHERE user_id = ? AND role IN ("owner", "admin")', (user_id,))
        return self.cursor.fetchone() is not None
    
    def is_manager(self, user_id: int) -> bool:
        self.cursor.execute('SELECT role FROM staff WHERE user_id = ? AND role IN ("owner", "admin", "manager")', (user_id,))
        return self.cursor.fetchone() is not None
    
    def add_staff(self, user_id: int, username: str, role: str, added_by: int):
        self.cursor.execute('''
            INSERT OR REPLACE INTO staff (user_id, username, role, added_by, added_at)
            VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)
        ''', (user_id, username, role, added_by))
        self.conn.commit()
    
    def remove_staff(self, user_id: int):
        self.cursor.execute('DELETE FROM staff WHERE user_id = ?', (user_id,))
        self.conn.commit()
    
    def get_all_staff(self) -> List[Dict]:
        self.cursor.execute('SELECT user_id, username, role FROM staff ORDER BY role DESC, added_at')
        columns = ['user_id', 'username', 'role']
        return [dict(zip(columns, row)) for row in self.cursor.fetchall()]
    
    # –ú–µ—Ç–æ–¥—ã –¥–ª—è NFT
    def add_nft_item(self, name: str, price: float, link: str):
        self.cursor.execute('''
            INSERT INTO nft_items (name, price, link, sort_order) 
            VALUES (?, ?, ?, (SELECT COALESCE(MAX(sort_order), 0) + 1 FROM nft_items))
        ''', (name, price, link))
        self.conn.commit()
        return self.cursor.lastrowid
    
    def get_nft_items(self, page: int = 0, sort_by: str = 'price_asc') -> List[Dict]:
        offset = page * 8
        order_by = {
            'price_asc': 'price ASC',
            'price_desc': 'price DESC',
            'newest': 'created_at DESC',
            'oldest': 'created_at ASC'
        }.get(sort_by, 'price ASC')
        
        self.cursor.execute(f'''
            SELECT id, name, price, link FROM nft_items 
            WHERE is_active = 1 
            ORDER BY {order_by} 
            LIMIT 8 OFFSET ?
        ''', (offset,))
        
        columns = ['id', 'name', 'price', 'link']
        return [dict(zip(columns, row)) for row in self.cursor.fetchall()]
    
    def get_nft_count(self) -> int:
        self.cursor.execute('SELECT COUNT(*) FROM nft_items WHERE is_active = 1')
        return self.cursor.fetchone()[0]
    
    # –ú–µ—Ç–æ–¥—ã –¥–ª—è –∑–∞–∫–∞–∑–æ–≤
    def create_order(self, user_id: int, order_type: str, details: str = "", price: float = 0) -> int:
        self.cursor.execute('''
            INSERT INTO orders (user_id, order_type, details, status, price, created_at)
            VALUES (?, ?, ?, 'a', ?, CURRENT_TIMESTAMP)
        ''', (user_id, order_type, details, price))
        order_id = self.cursor.lastrowid
        self.conn.commit()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        today = datetime.now().date()
        self.cursor.execute('''
            INSERT OR IGNORE INTO statistics (date) VALUES (?)
        ''', (today,))
        self.cursor.execute('''
            UPDATE statistics SET orders = orders + 1 WHERE date = ?
        ''', (today,))
        
        if order_type == 'nft':
            self.cursor.execute('UPDATE statistics SET nft_sold = nft_sold + 1 WHERE date = ?', (today,))
        elif order_type == 'stars':
            self.cursor.execute('UPDATE statistics SET stars_sold = stars_sold + 1 WHERE date = ?', (today,))
        elif order_type == 'premium':
            self.cursor.execute('UPDATE statistics SET premium_sold = premium_sold + 1 WHERE date = ?', (today,))
        
        self.conn.commit()
        return order_id
    
    def update_order_status(self, order_id: int, status: str, admin_id: int = None, admin_username: str = None):
        if admin_id:
            self.cursor.execute('''
                UPDATE orders SET status = ?, admin_id = ?, admin_username = ?, updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (status, admin_id, admin_username, order_id))
        else:
            self.cursor.execute('''
                UPDATE orders SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
            ''', (status, order_id))
        self.conn.commit()
    
    def get_order(self, order_id: int) -> Optional[Dict]:
        self.cursor.execute('''
            SELECT o.*, u.username, u.first_name 
            FROM orders o 
            LEFT JOIN users u ON o.user_id = u.user_id 
            WHERE o.id = ?
        ''', (order_id,))
        
        row = self.cursor.fetchone()
        if row:
            columns = [desc[0] for desc in self.cursor.description]
            return dict(zip(columns, row))
        return None
    
    def get_active_orders(self) -> List[Dict]:
        self.cursor.execute('''
            SELECT o.*, u.username 
            FROM orders o 
            LEFT JOIN users u ON o.user_id = u.user_id 
            WHERE o.status IN ('a', 'b')
            ORDER BY o.created_at DESC
        ''')
        
        columns = [desc[0] for desc in self.cursor.description]
        return [dict(zip(columns, row)) for row in self.cursor.fetchall()]
    
    def get_user_orders(self, user_id: int) -> List[Dict]:
        self.cursor.execute('''
            SELECT * FROM orders WHERE user_id = ? ORDER BY created_at DESC LIMIT 10
        ''', (user_id,))
        
        columns = [desc[0] for desc in self.cursor.description]
        return [dict(zip(columns, row)) for row in self.cursor.fetchall()]
    
    # –ú–µ—Ç–æ–¥—ã –¥–ª—è –∞—É–∫—Ü–∏–æ–Ω–∞
    def create_auction(self, name: str, start_time: str, auction_type: str, entry_price: float, promo_code: str = None) -> int:
        self.cursor.execute('''
            INSERT INTO auctions (name, start_time, type, entry_price, promo_code, status)
            VALUES (?, ?, ?, ?, ?, 'pending')
        ''', (name, start_time, auction_type, entry_price, promo_code))
        self.conn.commit()
        return self.cursor.lastrowid
    
    def update_auction(self, auction_id: int, **kwargs):
        if not kwargs:
            return
        
        set_clause = ', '.join([f"{key} = ?" for key in kwargs.keys()])
        values = list(kwargs.values())
        values.append(auction_id)
        
        self.cursor.execute(f'''
            UPDATE auctions SET {set_clause} WHERE id = ?
        ''', values)
        self.conn.commit()
    
    def get_auctions(self) -> List[Dict]:
        self.cursor.execute('SELECT * FROM auctions WHERE status != "ended" ORDER BY start_time')
        columns = [desc[0] for desc in self.cursor.description]
        return [dict(zip(columns, row)) for row in self.cursor.fetchall()]
    
    def get_auction_by_id(self, auction_id: int) -> Optional[Dict]:
        self.cursor.execute('SELECT * FROM auctions WHERE id = ?', (auction_id,))
        row = self.cursor.fetchone()
        if row:
            columns = [desc[0] for desc in self.cursor.description]
            return dict(zip(columns, row))
        return None
    
    def add_auction_participant(self, auction_id: int, user_id: int, username: str):
        try:
            self.cursor.execute('''
                INSERT OR IGNORE INTO auction_participants (auction_id, user_id, username)
                VALUES (?, ?, ?)
            ''', (auction_id, user_id, username))
            self.conn.commit()
            return True
        except:
            return False
    
    def get_auction_participants(self, auction_id: int) -> List[Dict]:
        self.cursor.execute('''
            SELECT user_id, username, paid FROM auction_participants 
            WHERE auction_id = ? ORDER BY joined_at
        ''', (auction_id,))
        return [{'user_id': row[0], 'username': row[1], 'paid': row[2]} for row in self.cursor.fetchall()]
    
    def get_auction_participant_count(self, auction_id: int) -> int:
        self.cursor.execute('SELECT COUNT(*) FROM auction_participants WHERE auction_id = ?', (auction_id,))
        return self.cursor.fetchone()[0]
    
    def add_auction_bid(self, auction_id: int, user_id: int, username: str, bid_amount: float):
        self.cursor.execute('''
            INSERT INTO auction_bids (auction_id, user_id, username, bid_amount)
            VALUES (?, ?, ?, ?)
        ''', (auction_id, user_id, username, bid_amount))
        self.conn.commit()
        return self.cursor.lastrowid
    
    def get_auction_bids(self, auction_id: int, limit: int = 10) -> List[Dict]:
        self.cursor.execute('''
            SELECT username, bid_amount, bid_time FROM auction_bids 
            WHERE auction_id = ? 
            ORDER BY bid_amount DESC, bid_time ASC 
            LIMIT ?
        ''', (auction_id, limit))
        return [{'username': row[0], 'bid_amount': row[1], 'bid_time': row[2]} for row in self.cursor.fetchall()]
    
    def get_highest_bid(self, auction_id: int) -> Optional[Dict]:
        self.cursor.execute('''
            SELECT user_id, username, bid_amount FROM auction_bids 
            WHERE auction_id = ? 
            ORDER BY bid_amount DESC, bid_time ASC 
            LIMIT 1
        ''', (auction_id,))
        row = self.cursor.fetchone()
        if row:
            return {'user_id': row[0], 'username': row[1], 'bid_amount': row[2]}
        return None
    
    # –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –∞—É–∫—Ü–∏–æ–Ω–∞
    def add_auction_item(self, auction_id: int, name: str, min_price: float, photo_id: str = None):
        self.cursor.execute('''
            INSERT INTO auction_items (auction_id, name, min_price, photo_id, status)
            VALUES (?, ?, ?, ?, 'pending')
        ''', (auction_id, name, min_price, photo_id))
        self.conn.commit()
        return self.cursor.lastrowid
    
    def get_auction_items(self, auction_id: int) -> List[Dict]:
        self.cursor.execute('''
            SELECT id, name, min_price, photo_id, status, winner_id, final_price 
            FROM auction_items 
            WHERE auction_id = ? 
            ORDER BY id
        ''', (auction_id,))
        
        columns = ['id', 'name', 'min_price', 'photo_id', 'status', 'winner_id', 'final_price']
        return [dict(zip(columns, row)) for row in self.cursor.fetchall()]
    
    def update_auction_item_status(self, item_id: int, status: str, winner_id: int = None, final_price: float = None):
        if winner_id and final_price:
            self.cursor.execute('''
                UPDATE auction_items SET status = ?, winner_id = ?, final_price = ?, sold_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (status, winner_id, final_price, item_id))
        else:
            self.cursor.execute('''
                UPDATE auction_items SET status = ? WHERE id = ?
            ''', (status, item_id))
        self.conn.commit()
    
    # –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ü–µ–Ω
    def get_star_prices(self) -> List[Dict]:
        self.cursor.execute('SELECT id, stars, price FROM star_prices ORDER BY id')
        return [{'id': row[0], 'stars': row[1], 'price': row[2]} for row in self.cursor.fetchall()]
    
    def update_star_price(self, price_id: int, new_price: float):
        self.cursor.execute('UPDATE star_prices SET price = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?', (new_price, price_id))
        self.conn.commit()
    
    def get_premium_prices(self, price_type: str = None) -> List[Dict]:
        if price_type:
            self.cursor.execute('SELECT id, type, period, price FROM premium_prices WHERE type = ? ORDER BY id', (price_type,))
        else:
            self.cursor.execute('SELECT id, type, period, price FROM premium_prices ORDER BY type, id')
        
        return [{'id': row[0], 'type': row[1], 'period': row[2], 'price': row[3]} for row in self.cursor.fetchall()]
    
    # –ú–µ—Ç–æ–¥—ã –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
    def add_promo_code(self, code: str, discount_percent: int = 0, discount_amount: float = 0, 
                       valid_until: str = None, uses_left: int = 1):
        self.cursor.execute('''
            INSERT OR REPLACE INTO promo_codes (code, discount_percent, discount_amount, valid_until, uses_left)
            VALUES (?, ?, ?, ?, ?)
        ''', (code, discount_percent, discount_amount, valid_until, uses_left))
        self.conn.commit()
    
    def check_promo_code(self, code: str) -> Optional[Dict]:
        self.cursor.execute('''
            SELECT discount_percent, discount_amount, valid_until, uses_left 
            FROM promo_codes 
            WHERE code = ? AND (uses_left > 0 OR uses_left IS NULL) 
            AND (valid_until IS NULL OR valid_until > CURRENT_TIMESTAMP)
        ''', (code,))
        
        row = self.cursor.fetchone()
        if row:
            return {
                'discount_percent': row[0],
                'discount_amount': row[1],
                'valid_until': row[2],
                'uses_left': row[3]
            }
        return None
    
    def use_promo_code(self, code: str):
        self.cursor.execute('''
            UPDATE promo_codes SET uses_left = uses_left - 1 
            WHERE code = ? AND (uses_left > 0 OR uses_left IS NULL)
        ''', (code,))
        self.conn.commit()
    
    # –ú–µ—Ç–æ–¥—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    def get_setting(self, key: str, default: str = None) -> str:
        self.cursor.execute('SELECT value FROM settings WHERE key = ?', (key,))
        result = self.cursor.fetchone()
        return result[0] if result else default
    
    def update_setting(self, key: str, value: str):
        self.cursor.execute('''
            INSERT OR REPLACE INTO settings (key, value, updated_at) 
            VALUES (?, ?, CURRENT_TIMESTAMP)
        ''', (key, value))
        self.conn.commit()
    
    # –ú–µ—Ç–æ–¥—ã –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    def get_statistics(self, days: int = 30) -> Dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π"""
        end_date = datetime.now().date()
        start_date = end_date - timedelta(days=days)
        
        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.cursor.execute('SELECT COUNT(*) FROM users')
        total_users = self.cursor.fetchone()[0]
        
        self.cursor.execute('SELECT COUNT(*) FROM orders')
        total_orders = self.cursor.fetchone()[0]
        
        self.cursor.execute('SELECT COUNT(*) FROM orders WHERE status = "s"')
        completed_orders = self.cursor.fetchone()[0]
        
        self.cursor.execute('SELECT SUM(price) FROM orders WHERE status = "s"')
        total_revenue = self.cursor.fetchone()[0] or 0
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥
        self.cursor.execute('''
            SELECT 
                SUM(new_users) as new_users,
                SUM(orders) as orders,
                SUM(revenue) as revenue,
                SUM(nft_sold) as nft_sold,
                SUM(stars_sold) as stars_sold,
                SUM(premium_sold) as premium_sold
            FROM statistics 
            WHERE date >= ? AND date <= ?
        ''', (start_date, end_date))
        
        row = self.cursor.fetchone()
        if row:
            period_stats = {
                'new_users': row[0] or 0,
                'orders': row[1] or 0,
                'revenue': row[2] or 0,
                'nft_sold': row[3] or 0,
                'stars_sold': row[4] or 0,
                'premium_sold': row[5] or 0
            }
        else:
            period_stats = {
                'new_users': 0, 'orders': 0, 'revenue': 0,
                'nft_sold': 0, 'stars_sold': 0, 'premium_sold': 0
            }
        
        return {
            'total_users': total_users,
            'total_orders': total_orders,
            'completed_orders': completed_orders,
            'total_revenue': total_revenue,
            'period_stats': period_stats,
            'period_days': days
        }
    
    def get_daily_stats(self, date: str = None) -> Dict:
        """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å"""
        if not date:
            date = datetime.now().date().isoformat()
        
        self.cursor.execute('''
            SELECT * FROM statistics WHERE date = ?
        ''', (date,))
        
        row = self.cursor.fetchone()
        if row:
            columns = [desc[0] for desc in self.cursor.description]
            return dict(zip(columns, row))
        
        return {}
    
    def close(self):
        self.conn.close()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
db = Database()

# ========== –°–ò–°–¢–ï–ú–ê –ó–ê–©–ò–¢–´ –û–¢ –°–ü–ê–ú–ê ==========
class SpamProtection:
    def __init__(self, limit=5, window=10):
        self.limit = limit
        self.window = window
        self.user_messages = defaultdict(list)
        self.spam_detected = set()
        self.mass_spam_detected = False
        self.mass_spam_users = set()
    
    def check_user(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ —Å–ø–∞–º–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"""
        now = datetime.now()
        
        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        self.user_messages[user_id] = [
            msg_time for msg_time in self.user_messages[user_id]
            if (now - msg_time).seconds < self.window
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        self.user_messages[user_id].append(now)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
        if len(self.user_messages[user_id]) > self.limit:
            self.spam_detected.add(user_id)
            db.ban_user(user_id)  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ —Å–ø–∞–º–∞
            spam_count = len([uid for uid in self.spam_detected 
                            if (now - self.user_messages[uid][-1]).seconds < 60])
            
            if spam_count > 10:  # –ï—Å–ª–∏ –±–æ–ª—å—à–µ 10 —Å–ø–∞–º–µ—Ä–æ–≤ –∑–∞ –º–∏–Ω—É—Ç—É
                self.mass_spam_detected = True
                self.mass_spam_users = self.spam_detected.copy()
                
                # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–ø–∞–º–µ—Ä–æ–≤
                asyncio.create_task(self.delete_spam_messages())
            
            return True
        
        return False
    
    def is_spammer(self, user_id: int) -> bool:
        return user_id in self.spam_detected
    
    def reset_user(self, user_id: int):
        if user_id in self.user_messages:
            del self.user_messages[user_id]
        if user_id in self.spam_detected:
            self.spam_detected.remove(user_id)
        if user_id in self.mass_spam_users:
            self.mass_spam_users.remove(user_id)
    
    async def delete_spam_messages(self):
        """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–∞—Å—Å–æ–≤—ã—Ö —Å–ø–∞–º–µ—Ä–æ–≤"""
        # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —Å–ø–∞–º–µ
        # –í —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –Ω—É–∂–Ω–æ –∏–º–µ—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        pass

spam_checker = SpamProtection()

# ========== –£–¢–ò–õ–ò–¢–´ ==========
def add_emoji(text: str, emoji_key: str = "info") -> str:
    """–î–æ–±–∞–≤–ª—è–µ—Ç —ç–º–æ–¥–∑–∏ –∫ —Ç–µ–∫—Å—Ç—É"""
    return f"{EMOJI.get(emoji_key, '‚ÑπÔ∏è')} {text}"

async def delete_previous_messages(chat_id: int, message_id: int, keep_last: int = 1):
    """–£–¥–∞–ª—è–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞"""
    try:
        # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å ID —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞
        # –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        pass
    except:
        pass

async def check_channel_subscription(user_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞–Ω–∞–ª"""
    try:
        member = await bot.get_chat_member(CHANNEL_ID, user_id)
        return member.status in ['member', 'administrator', 'creator']
    except Exception as e:
        logging.error(f"Error checking subscription: {e}")
        return False

def format_order_message(order_data: Dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–∫–∞–∑–µ –¥–ª—è –≥—Ä—É–ø–ø—ã –∞–¥–º–∏–Ω–æ–≤"""
    status_text = {
        'a': '‚ùå –ù–µ –≤–∑—è—Ç–æ',
        'b': 'üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ',
        'd': '‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º',
        's': '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ',
        'z': 'üö´ –°–ü–ê–ú',
        'g': 'üí≥ –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ',
        'v': 'üìù –û—Ç–∑—ã–≤'
    }
    
    return f"""{EMOJI['warning']} *–ù–û–í–´–ô –ó–ê–ö–ê–ó* {EMOJI['warning']}

1. *–ù–æ–º–µ—Ä:* #{order_data['id']}
2. *ID:* `{order_data['user_id']}`
3. *–ù–∏–∫:* @{order_data.get('username', '–ù–µ—Ç')}
4. *–ü—Ä–∏—á–∏–Ω–∞:* {order_data['order_type'].upper()}
5. *–î–∞—Ç–∞:* {order_data['created_at'][:19] if order_data['created_at'] else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
6. *–°–æ—Å—Ç–æ—è–Ω–∏–µ:* {status_text.get(order_data['status'], '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}

üìã *–î–µ—Ç–∞–ª–∏:* {order_data.get('details', '–ù–µ—Ç')}"""

def generate_captcha() -> Tuple[str, str]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—É—é –∫–∞–ø—á—É –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã
    letters_ru = '–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø'
    digits = '0123456789'
    
    # –°–æ–∑–¥–∞–µ–º –∫–æ–¥ –∏–∑ 6 —Å–∏–º–≤–æ–ª–æ–≤: 4 —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã –∏ 2 —Ü–∏—Ñ—Ä—ã
    code_chars = []
    for _ in range(4):
        code_chars.append(random.choice(letters_ru))
    for _ in range(2):
        code_chars.append(random.choice(digits))
    
    # –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º
    random.shuffle(code_chars)
    captcha_text = ''.join(code_chars)
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    numbers = ''.join([c for c in captcha_text if c.isdigit()])
    
    return captcha_text, numbers

def generate_verification_code() -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
    return ''.join([str(random.randint(0, 9)) for _ in range(5)])

def generate_promo_code() -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥"""
    letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
    digits = '0123456789'
    
    # –§–æ—Ä–º–∞—Ç: XXX-XXX –∏–ª–∏ —Å–ª–æ–≤–æ
    if random.random() > 0.5:
        # –°–ª–æ–≤–æ
        words = ['START', 'BONUS', 'GIFT', 'WINNER', 'PROMO', 'DISCOUNT', 'SALE']
        code = random.choice(words)
    else:
        # XXX-XXX —Ñ–æ—Ä–º–∞—Ç
        part1 = ''.join(random.choices(letters + digits, k=3))
        part2 = ''.join(random.choices(letters + digits, k=3))
        code = f"{part1}-{part2}"
    
    return code

async def create_forum_topic(chat_id: int, title: str) -> Optional[int]:
    """–°–æ–∑–¥–∞–µ—Ç —Ç–µ–º—É –≤ –≥—Ä—É–ø–ø–µ-—Ñ–æ—Ä—É–º–µ"""
    try:
        # –í aiogram 3.x —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–º —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ message_thread_id
        # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None (–±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –æ–±—â–∏–π —á–∞—Ç)
        # –í —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–æ–¥ create_forum_topic
        return None
    except:
        return None

async def send_support_notification(order_id: int, user_data: Dict, order_type: str, details: str = ""):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–∫–∞–∑–µ –≤ –≥—Ä—É–ø–ø—É –∞–¥–º–∏–Ω–æ–≤"""
    # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –ë–î
    price = 0
    if order_type == 'nft':
        price = 100  # –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞
    elif order_type == 'stars':
        price = 199  # –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞
    elif order_type == 'premium':
        price = 10   # –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞
    
    db_order_id = db.create_order(
        user_id=user_data['id'],
        order_type=order_type,
        details=details,
        price=price
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
    order_data = db.get_order(db_order_id)
    if not order_data:
        return
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    order_message = format_order_message(order_data)
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ–º—É –≤ –≥—Ä—É–ø–ø–µ
    topic_title = f"{order_type.upper()} | {user_data['username']}"
    thread_id = await create_forum_topic(ADMIN_GROUP_ID, topic_title)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º thread_id
    if thread_id:
        db.cursor.execute('UPDATE orders SET forum_topic_id = ? WHERE id = ?', (thread_id, db_order_id))
        db.conn.commit()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    keyboard = get_order_actions_keyboard(db_order_id)
    
    try:
        if thread_id:
            sent_message = await bot.send_message(
                chat_id=ADMIN_GROUP_ID,
                text=order_message,
                reply_markup=keyboard,
                parse_mode="Markdown",
                message_thread_id=thread_id
            )
        else:
            sent_message = await bot.send_message(
                chat_id=ADMIN_GROUP_ID,
                text=order_message,
                reply_markup=keyboard,
                parse_mode="Markdown"
            )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –∫–∞–∫ thread_id
        db.cursor.execute('UPDATE orders SET thread_id = ? WHERE id = ?', (sent_message.message_id, db_order_id))
        db.conn.commit()
        
    except Exception as e:
        logging.error(f"Error sending support notification: {e}")

async def send_auction_notification(auction_id: int, user_data: Dict):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—á–∞—Å—Ç–∏–∏ –≤ –∞—É–∫—Ü–∏–æ–Ω–µ"""
    order_message = f"""{EMOJI['auction']} *–ù–û–í–ê–Ø –ó–ê–Ø–í–ö–ê –ù–ê –ê–£–ö–¶–ò–û–ù* {EMOJI['auction']}

1. *–ù–æ–º–µ—Ä –∞—É–∫—Ü–∏–æ–Ω–∞:* #{auction_id}
2. *ID —É—á–∞—Å—Ç–Ω–∏–∫–∞:* `{user_data['id']}`
3. *–ù–∏–∫:* @{user_data.get('username', '–ù–µ—Ç')}
4. *–î–∞—Ç–∞:* {datetime.now().strftime('%d.%m.%Y %H:%M')}
5. *–°—Ç–∞—Ç—É—Å:* ‚ùå –ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ"""

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É", callback_data=f"auction_pay_{auction_id}_{user_data['id']}")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"auction_reject_{auction_id}_{user_data['id']}")]
    ])
    
    try:
        await bot.send_message(
            chat_id=ADMIN_GROUP_ID,
            text=order_message,
            reply_markup=keyboard,
            parse_mode="Markdown"
        )
    except Exception as e:
        logging.error(f"Error sending auction notification: {e}")

async def schedule_auction_notification(auction_id: int, auction_name: str, start_time: datetime):
    """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 5 –º–∏–Ω—É—Ç –¥–æ –∞—É–∫—Ü–∏–æ–Ω–∞"""
    # –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –∑–∞ 5 –º–∏–Ω—É—Ç –¥–æ –Ω–∞—á–∞–ª–∞
    notify_time = start_time - timedelta(minutes=5)
    now = datetime.now()
    
    if notify_time > now:
        # –í—ã—á–∏—Å–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        delay = (notify_time - now).total_seconds()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É
        asyncio.create_task(
            send_auction_reminder(auction_id, auction_name, delay)
        )
        
        logging.info(f"Scheduled notification for auction {auction_id} in {delay} seconds")

async def send_auction_reminder(auction_id: int, auction_name: str, delay: float):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –∞—É–∫—Ü–∏–æ–Ω–∞ –∑–∞ 5 –º–∏–Ω—É—Ç –¥–æ –Ω–∞—á–∞–ª–∞"""
    try:
        # –ñ–¥–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
        await asyncio.sleep(delay)
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        participants = db.get_auction_participants(auction_id)
        
        for participant in participants:
            try:
                await bot.send_message(
                    chat_id=participant['user_id'],
                    text=f"{EMOJI['bell']} *–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!*\n\n"
                         f"–ê—É–∫—Ü–∏–æ–Ω '{auction_name}' –Ω–∞—á–Ω–µ—Ç—Å—è —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç!\n"
                         f"–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ —É—á–∞—Å—Ç–∏—é.",
                    parse_mode="Markdown"
                )
                
                # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–Ω–æ–≥–æ
                db.cursor.execute('''
                    UPDATE auction_participants SET notified = 1 
                    WHERE auction_id = ? AND user_id = ?
                ''', (auction_id, participant['user_id']))
                db.conn.commit()
                
            except Exception as e:
                logging.error(f"Error sending reminder to {participant['user_id']}: {e}")
        
        # –ü–æ–º–µ—á–∞–µ–º –∞—É–∫—Ü–∏–æ–Ω –∫–∞–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–Ω—ã–π
        db.cursor.execute('UPDATE auctions SET notified_5min = 1 WHERE id = ?', (auction_id,))
        db.conn.commit()
        
    except asyncio.CancelledError:
        pass
    except Exception as e:
        logging.error(f"Error in auction reminder: {e}")

# ========== –ö–õ–ê–í–ò–ê–¢–£–†–´ ==========
def get_main_keyboard() -> InlineKeyboardMarkup:
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    buttons = [
        [InlineKeyboardButton(text=f"{EMOJI['nft']} –ö—É–ø–∏—Ç—å NFT –ø–æ–¥–∞—Ä–æ–∫", callback_data="buy_nft")],
        [InlineKeyboardButton(text=f"{EMOJI['stars']} –ö—É–ø–∏—Ç—å —Ç–≥ –∑–≤–µ–∑–¥—ã", callback_data="buy_stars")],
        [InlineKeyboardButton(text=f"{EMOJI['premium']} –ö—É–ø–∏—Ç—å —Ç–≥ –ø—Ä–µ–º–∏—É–º", callback_data="buy_premium")],
        [InlineKeyboardButton(text=f"{EMOJI['auction']} –ê—É–∫—Ü–∏–æ–Ω", callback_data="auction")],
        [InlineKeyboardButton(text=f"{EMOJI['reviews']} –û—Ç–∑—ã–≤—ã", callback_data="reviews")],
        [InlineKeyboardButton(text=f"{EMOJI['support']} –ü–æ–¥–¥–µ—Ä–∂–∫–∞", callback_data="support")],
        [InlineKeyboardButton(text=f"{EMOJI['settings']} –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="settings")]
    ]
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_admin_main_keyboard() -> InlineKeyboardMarkup:
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    buttons = [
        [InlineKeyboardButton(text=f"{EMOJI['money']} –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–µ–Ω—ã —Ç–≥ –∑–≤–µ–∑–¥", callback_data="admin_stars_price")],
        [InlineKeyboardButton(text=f"{EMOJI['nft']} –î–æ–±–∞–≤–ª–µ–Ω–∏–µ NFT –ø–æ–¥–∞—Ä–∫–∞", callback_data="admin_add_nft")],
        [InlineKeyboardButton(text=f"{EMOJI['stats']} –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")],
        [InlineKeyboardButton(text=f"{EMOJI['lock']} –í–∫–ª/–í—ã–∫–ª –∫–∞–ø—á—É", callback_data="admin_captcha")],
        [InlineKeyboardButton(text=f"{EMOJI['stop']} –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞", callback_data="admin_stop_bot")],
        [InlineKeyboardButton(text=f"{EMOJI['warning']} –ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data="admin_ban")],
        [InlineKeyboardButton(text=f"{EMOJI['error']} –ó–∞–±–∞–Ω–∏—Ç—å —Å–ø–∞–º–µ—Ä–æ–≤", callback_data="admin_spam_ban")],
        [InlineKeyboardButton(text=f"{EMOJI['add']} –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞/–º–æ–¥–µ—Ä–∞", callback_data="admin_add_staff")],
        [InlineKeyboardButton(text=f"{EMOJI['settings']} –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É–∫—Ü–∏–æ–Ω–∞", callback_data="admin_auction_settings")],
        [InlineKeyboardButton(text=f"{EMOJI['auction']} –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–æ–º", callback_data="admin_auction_manage")],
        [InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data="back_to_main")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_order_actions_keyboard(order_id: int) -> InlineKeyboardMarkup:
    """–ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∑–∞–∫–∞–∑–∞"""
    buttons = [
        [
            InlineKeyboardButton(text="‚úÖ –í–∑—è—Ç—å –∑–∞–∫–∞–∑", callback_data=f"order_take_{order_id}"),
            InlineKeyboardButton(text="‚ùå –°–ü–ê–ú", callback_data=f"order_spam_{order_id}")
        ],
        [
            InlineKeyboardButton(text="üí∞ –ù–µ—Ç –æ–ø–ª–∞—Ç—ã", callback_data=f"order_no_pay_{order_id}"),
            InlineKeyboardButton(text="üìù –û—Ç–∑—ã–≤", callback_data=f"order_review_{order_id}")
        ],
        [
            InlineKeyboardButton(text="üîÑ –†–µ—Å—Ç–∞—Ä—Ç", callback_data=f"order_restart_{order_id}"),
            InlineKeyboardButton(text="‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å", callback_data=f"order_complete_{order_id}")
        ]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_auction_management_keyboard(auction_id: int) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—É–∫—Ü–∏–æ–Ω–æ–º –¥–ª—è –∞–¥–º–∏–Ω–∞"""
    buttons = [
        [InlineKeyboardButton(text="üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏", callback_data=f"auction_participants_{auction_id}")],
        [InlineKeyboardButton(text="üéÅ –í—ã—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–∑", callback_data=f"auction_add_prize_{auction_id}")],
        [InlineKeyboardButton(text="üèÅ –ó–∞–∫–æ–Ω—á–∏—Ç—å –∞—É–∫—Ü–∏–æ–Ω", callback_data=f"auction_end_{auction_id}")],
        [InlineKeyboardButton(text="üì° –°—Ç—Ä–∏–º", callback_data=f"auction_stream_{auction_id}")],
        [InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data=f"auction_stats_{auction_id}")],
        [InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data="admin_auction_manage")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_auction_bidding_keyboard(auction_id: int) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ç–∞–≤–æ–∫ –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω–µ"""
    buttons = [
        [
            InlineKeyboardButton(text="‚ûï1", callback_data=f"bid_{auction_id}_1"),
            InlineKeyboardButton(text="‚ûï50", callback_data=f"bid_{auction_id}_50"),
            InlineKeyboardButton(text="‚ûï100", callback_data=f"bid_{auction_id}_100")
        ],
        [
            InlineKeyboardButton(text="üí∞ –°–≤–æ—è —Ü–µ–Ω–∞", callback_data=f"bid_custom_{auction_id}"),
            InlineKeyboardButton(text="üö´ –í—ã–π—Ç–∏", callback_data=f"auction_leave_{auction_id}")
        ]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_stats_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    buttons = [
        [InlineKeyboardButton(text="üìÖ –ó–∞ —Å–µ–≥–æ–¥–Ω—è", callback_data="stats_today")],
        [InlineKeyboardButton(text="üìÜ –ó–∞ –Ω–µ–¥–µ–ª—é", callback_data="stats_week")],
        [InlineKeyboardButton(text="üìä –ó–∞ –º–µ—Å—è—Ü", callback_data="stats_month")],
        [InlineKeyboardButton(text="üìà –û–±—â–∞—è", callback_data="stats_total")],
        [InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data="admin_menu")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ==========
@dp.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_id = message.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–Ω
    if db.is_banned(user_id):
        await message.answer(f"{EMOJI['error']} –í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞.")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞–Ω–∞–ª
    if not await check_channel_subscription(user_id):
        await state.set_state(UserStates.waiting_subscription)
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üì¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª", url=f"https://t.me/{CHANNEL_ID[1:]}")],
            [InlineKeyboardButton(text="‚úÖ –Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è", callback_data="check_subscription")]
        ])
        
        await message.answer(
            f"{EMOJI['warning']} *–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª!*\n\n"
            f"1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª'\n"
            f"2. –ü–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞–∂–º–∏—Ç–µ '–Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è'\n\n"
            f"–ö–∞–Ω–∞–ª: {CHANNEL_ID}",
            reply_markup=keyboard,
            parse_mode="Markdown"
        )
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    db.add_user(
        user_id=user_id,
        username=message.from_user.username,
        first_name=message.from_user.first_name,
        last_name=message.from_user.last_name or ""
    )
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
    db.update_subscription(user_id, True)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–ø—á—É
    captcha_enabled = db.get_setting('captcha_enabled', '1') == '1'
    if captcha_enabled:
        captcha_text, numbers = generate_captcha()
        await state.set_state(UserStates.waiting_captcha)
        await state.update_data(captcha_numbers=numbers)
        
        await message.answer(
            f"{EMOJI['lock']} *–ü—Ä–æ–π–¥–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏*\n\n"
            f"–í–≤–µ–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ *—Ü–∏—Ñ—Ä—ã* –∏–∑ –∫–æ–¥–∞:\n`{captcha_text}`\n\n"
            f"–ü—Ä–∏–º–µ—Ä: –µ—Å–ª–∏ –∫–æ–¥ '–ê1–ë2–í3', –≤–≤–µ–¥–∏—Ç–µ '12'",
            parse_mode="Markdown"
        )
        return
    
    await show_main_menu(message, state)

async def show_main_menu(message: Message, state: FSMContext):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    await state.set_state(UserStates.main_menu)
    
    welcome_text = f"""
    {EMOJI['main']} *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é!* {EMOJI['main']}

    üöÄ *–ú—ã —Ä–∞–¥—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤–∞—Å –≤ –Ω–∞—à–µ–º –±–æ—Ç–µ!*
    
    ‚ú® *–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ:*
    ‚Ä¢ üéÅ –ö—É–ø–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ NFT –ø–æ–¥–∞—Ä–∫–∏
    ‚Ä¢ ‚≠ê –ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ Telegram Stars
    ‚Ä¢ üëë –û—Ñ–æ—Ä–º–∏—Ç—å Telegram Premium
    ‚Ä¢ üî® –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏—Ö –∞—É–∫—Ü–∏–æ–Ω–∞—Ö
    ‚Ä¢ üìù –û—Å—Ç–∞–≤–∏—Ç—å –∏–ª–∏ –ø–æ—á–∏—Ç–∞—Ç—å –æ—Ç–∑—ã–≤—ã
    ‚Ä¢ üÜò –ü–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å –æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    
    ‚ö° *–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:*
    1. –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª
    2. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º
    3. –ü–æ–ª—É—á–∏—Ç–µ —Å–≤–æ–π –∑–∞–∫–∞–∑!
    
    üí´ *–£–¥–∞—á–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫!*
    """
    
    await message.answer_photo(
        photo="https://via.placeholder.com/600x400/0088cc/FFFFFF?text=NFT+Marketplace",
        caption=welcome_text,
        reply_markup=get_main_keyboard(),
        parse_mode="Markdown"
    )

@dp.message(Command("admin"))
async def cmd_admin(message: Message, state: FSMContext):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏"""
    user_id = message.from_user.id
    
    if not db.is_admin(user_id):
        await message.answer(f"{EMOJI['error']} –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.")
        return
    
    await state.set_state(AdminStates.admin_menu)
    
    admin_text = f"""
    {EMOJI['admin']} *–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞* {EMOJI['admin']}
    
    üëë *–£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞:* {'–í–ª–∞–¥–µ–ª–µ—Ü' if db.is_owner(user_id) else '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}
    üë§ *–í–∞—à ID:* `{user_id}`
    
    üìä *–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:*
    
    1. {EMOJI['money']} –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–µ–Ω TG Stars
    2. {EMOJI['nft']} –î–æ–±–∞–≤–ª–µ–Ω–∏–µ NFT –ø–æ–¥–∞—Ä–∫–æ–≤
    3. {EMOJI['stats']} –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞
    4. {EMOJI['lock']} –í–∫–ª/–í—ã–∫–ª –∫–∞–ø—á—É
    5. {EMOJI['stop']} –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
    6. {EMOJI['warning']} –ë–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    7. {EMOJI['error']} –ë–∞–Ω —Å–ø–∞–º–µ—Ä–æ–≤
    8. {EMOJI['add']} –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞/–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞
    9. {EMOJI['settings']} –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É–∫—Ü–∏–æ–Ω–∞
    10. {EMOJI['auction']} –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–æ–º
    """
    
    await message.answer(
        admin_text,
        reply_markup=get_admin_main_keyboard(),
        parse_mode="Markdown"
    )

@dp.message(Command("stats"))
async def cmd_stats(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–¥–æ—Å—Ç—É–ø–Ω–∞ –∞–¥–º–∏–Ω–∞–º)"""
    user_id = message.from_user.id
    
    if not db.is_admin(user_id):
        await message.answer(f"{EMOJI['error']} –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ.")
        return
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ —Å–µ–≥–æ–¥–Ω—è
    stats = db.get_statistics(days=1)
    
    stats_text = f"""
    {EMOJI['stats']} *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è* {EMOJI['stats']}
    
    üë• *–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:* {stats['period_stats']['new_users']}
    üì¶ *–ó–∞–∫–∞–∑–æ–≤:* {stats['period_stats']['orders']}
    üí∞ *–í—ã—Ä—É—á–∫–∞:* {stats['period_stats']['revenue']:.2f}‚ÇΩ
    
    üéÅ *NFT –ø—Ä–æ–¥–∞–Ω–æ:* {stats['period_stats']['nft_sold']}
    ‚≠ê *Stars –ø—Ä–æ–¥–∞–Ω–æ:* {stats['period_stats']['stars_sold']}
    üëë *Premium –ø—Ä–æ–¥–∞–Ω–æ:* {stats['period_stats']['premium_sold']}
    
    üìä *–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*
    ‚Ä¢ –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}
    ‚Ä¢ –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: {stats['total_orders']}
    ‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: {stats['completed_orders']}
    ‚Ä¢ –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: {stats['total_revenue']:.2f}‚ÇΩ
    """
    
    await message.answer(
        stats_text,
        reply_markup=get_stats_keyboard(),
        parse_mode="Markdown"
    )

# ========== –û–ë–†–ê–ë–û–¢–ö–ê –û–°–ù–û–í–ù–û–ì–û –ú–ï–ù–Æ ==========
@dp.callback_query(F.data == "check_subscription")
async def check_subscription_callback(callback: CallbackQuery, state: FSMContext):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª"""
    if await check_channel_subscription(callback.from_user.id):
        db.update_subscription(callback.from_user.id, True)
        await callback.answer("‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!")
        await show_main_menu(callback.message, state)
    else:
        await callback.answer("‚ùå –í—ã –µ—â—ë –Ω–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª!", show_alert=True)

@dp.callback_query(F.data == "back_to_main")
async def back_to_main(callback: CallbackQuery, state: FSMContext):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    await show_main_menu(callback.message, state)
    await callback.answer()

@dp.callback_query(F.data == "admin_menu")
async def admin_menu_callback(callback: CallbackQuery, state: FSMContext):
    """–î–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏"""
    user_id = callback.from_user.id
    
    if not db.is_admin(user_id):
        await callback.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏!", show_alert=True)
        return
    
    await state.set_state(AdminStates.admin_menu)
    
    admin_text = f"""
    {EMOJI['admin']} *–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞* {EMOJI['admin']}
    
    üëë *–£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞:* {'–í–ª–∞–¥–µ–ª–µ—Ü' if db.is_owner(user_id) else '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}
    üë§ *–í–∞—à ID:* `{user_id}`
    
    –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª:
    """
    
    await callback.message.edit_caption(
        caption=admin_text,
        reply_markup=get_admin_main_keyboard(),
        parse_mode="Markdown"
    )
    await callback.answer()

# ========== –û–ë–†–ê–ë–û–¢–ö–ê –ö–ê–ü–ß–ò ==========
@dp.message(UserStates.waiting_captcha)
async def process_captcha(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω–æ–π –∫–∞–ø—á–∏"""
    data = await state.get_data()
    expected_numbers = data.get('captcha_numbers', '')
    
    if message.text == expected_numbers:
        await message.answer(f"{EMOJI['success']} *–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!*", parse_mode="Markdown")
        await show_main_menu(message, state)
    else:
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—É—é –∫–∞–ø—á—É
        captcha_text, numbers = generate_captcha()
        await state.update_data(captcha_numbers=numbers)
        
        await message.answer(
            f"{EMOJI['error']} *–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.*\n\n"
            f"–í–≤–µ–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ *—Ü–∏—Ñ—Ä—ã* –∏–∑ –∫–æ–¥–∞:\n`{captcha_text}`",
            parse_mode="Markdown"
        )

# ========== –ü–û–ö–£–ü–ö–ê NFT ==========
@dp.callback_query(F.data == "buy_nft")
async def buy_nft_handler(callback: CallbackQuery, state: FSMContext):
    """–ü–æ–∫—É–ø–∫–∞ NFT"""
    await state.set_state(UserStates.buy_nft)
    
    nft_count = db.get_nft_count()
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
    builder = InlineKeyboardBuilder()
    
    # –ö–Ω–æ–ø–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    builder.row(
        InlineKeyboardButton(text="ü™ô –î–µ—à—ë–≤—ã–µ", callback_data="nft_sort_price_asc"),
        InlineKeyboardButton(text="üÜï –ù–æ–≤—ã–µ", callback_data="nft_sort_newest"),
        InlineKeyboardButton(text="üíé –î–æ—Ä–æ–≥–∏–µ", callback_data="nft_sort_price_desc")
    )
    
    # –ü–æ–ª—É—á–∞–µ–º NFT
    nft_items = db.get_nft_items(sort_by='price_asc')
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ NFT (–ø–µ—Ä–≤—ã–µ 8)
    for i, item in enumerate(nft_items[:8]):
        builder.row(InlineKeyboardButton(
            text=f"{item['name']} | {item['price']}$",
            callback_data=f"nft_select_{item['id']}"
        ))
    
    # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    builder.row(
        InlineKeyboardButton(text="‚óÄÔ∏è", callback_data="nft_page_prev_0"),
        InlineKeyboardButton(text="üè†", callback_data="back_to_main"),
        InlineKeyboardButton(text="‚ñ∂Ô∏è", callback_data="nft_page_next_0")
    )
    
    text = f"""
    {EMOJI['nft']} *–ú–∞–≥–∞–∑–∏–Ω NFT –ø–æ–¥–∞—Ä–∫–æ–≤* {EMOJI['nft']}
    
    üéØ *–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∞—Ä–æ–∫ –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è:*
    
    üîÑ *–†–µ–∂–∏–º—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏:*
    ‚Ä¢ ü™ô –î–µ—à—ë–≤—ã–µ - —Å–Ω–∞—á–∞–ª–∞ –Ω–µ–¥–æ—Ä–æ–≥–∏–µ
    ‚Ä¢ üÜï –ù–æ–≤—ã–µ - —Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ
    ‚Ä¢ üíé –î–æ—Ä–æ–≥–∏–µ - —Å–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ
    
    üìä *–í—Å–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ: {nft_count} –ø–æ–¥–∞—Ä–∫–æ–≤*
    """
    
    await callback.message.answer_photo(
        photo="https://via.placeholder.com/600x300/9c27b0/FFFFFF?text=NFT+Gifts",
        caption=text,
        reply_markup=builder.as_markup(),
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.callback_query(F.data.startswith("nft_select_"))
async def select_nft_callback(callback: CallbackQuery):
    """–í—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ NFT"""
    nft_id = int(callback.data.split("_")[-1])
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ NFT
    nft_items = db.get_nft_items()
    nft_item = next((item for item in nft_items if item['id'] == nft_id), None)
    
    if nft_item:
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üõí –ö—É–ø–∏—Ç—å", callback_data=f"nft_buy_{nft_id}")],
            [InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data="buy_nft")]
        ])
        
        await callback.message.answer(
            f"{EMOJI['nft']} *{nft_item['name']}*\n\n"
            f"üí∞ *–¶–µ–Ω–∞:* {nft_item['price']}$\n"
            f"üîó *–°—Å—ã–ª–∫–∞:* {nft_item['link']}\n\n"
            f"–ù–∞–∂–º–∏—Ç–µ '–ö—É–ø–∏—Ç—å' —á—Ç–æ–±—ã –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ —ç—Ç–æ—Ç NFT –ø–æ–¥–∞—Ä–æ–∫.",
            reply_markup=keyboard,
            parse_mode="Markdown"
        )
    await callback.answer()

@dp.callback_query(F.data.startswith("nft_buy_"))
async def buy_nft_callback(callback: CallbackQuery):
    """–ü–æ–∫—É–ø–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ NFT"""
    nft_id = int(callback.data.split("_")[-1])
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ NFT
    nft_items = db.get_nft_items()
    nft_item = next((item for item in nft_items if item['id'] == nft_id), None)
    
    if not nft_item:
        await callback.answer("‚ùå NFT –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É –∞–¥–º–∏–Ω–æ–≤
    user_data = {
        'id': callback.from_user.id,
        'username': callback.from_user.username or f"user_{callback.from_user.id}"
    }
    
    await send_support_notification(
        order_id=nft_id,
        user_data=user_data,
        order_type='nft',
        details=f"NFT: {nft_item['name']} - {nft_item['price']}$"
    )
    
    await callback.message.answer(
        f"{EMOJI['success']} *–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!*\n\n"
        f"üéÅ *–¢–æ–≤–∞—Ä:* {nft_item['name']}\n"
        f"üí∞ *–¶–µ–Ω–∞:* {nft_item['price']}$\n\n"
        f"–° –≤–∞–º–∏ —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏.\n"
        f"üïê –û–±—ã—á–Ω–æ –æ—Ç–≤–µ—Ç –∑–∞–Ω–∏–º–∞–µ—Ç 5-15 –º–∏–Ω—É—Ç.",
        parse_mode="Markdown"
    )
    await callback.answer()

# ========== –ü–û–ö–£–ü–ö–ê STARTS ==========
@dp.callback_query(F.data == "buy_stars")
async def buy_stars_handler(callback: CallbackQuery, state: FSMContext):
    """–ü–æ–∫—É–ø–∫–∞ Telegram Stars"""
    await state.set_state(UserStates.buy_stars)
    
    # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—ã
    star_prices = db.get_star_prices()
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    builder = InlineKeyboardBuilder()
    
    for price in star_prices:
        builder.row(InlineKeyboardButton(
            text=f"{price['stars']} –∑–≤–µ–∑–¥ - {price['price']}‚ÇΩ",
            callback_data=f"stars_{price['id']}"
        ))
    
    builder.row(InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    
    text = f"""
    {EMOJI['stars']} *–ü–æ–∫—É–ø–∫–∞ Telegram Stars* {EMOJI['stars']}
    
    ‚≠ê *–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥:*
    
    üí´ *–ó–≤—ë–∑–¥—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è:*
    ‚Ä¢ –ß–∞–µ–≤—ã—Ö –∞–≤—Ç–æ—Ä–∞–º
    ‚Ä¢ –ü–æ–∫—É–ø–∫–∏ —Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
    ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π
    ‚Ä¢ –ü–æ–∫—É–ø–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤ –≤ Telegram
    
    ‚ö° *–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã!*
    """
    
    await callback.message.answer(
        text,
        reply_markup=builder.as_markup(),
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.callback_query(F.data.startswith("stars_"))
async def select_stars_callback(callback: CallbackQuery):
    """–í—ã–±–æ—Ä –ø–∞–∫–µ—Ç–∞ –∑–≤–µ–∑–¥"""
    package_id = int(callback.data.split("_")[1])
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–∫–µ—Ç–µ
    star_prices = db.get_star_prices()
    package = next((p for p in star_prices if p['id'] == package_id), None)
    
    if not package:
        await callback.answer("‚ùå –ü–∞–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    user_data = {
        'id': callback.from_user.id,
        'username': callback.from_user.username or f"user_{callback.from_user.id}"
    }
    
    await send_support_notification(
        order_id=package_id,
        user_data=user_data,
        order_type='stars',
        details=f"{package['stars']} –∑–≤–µ–∑–¥ - {package['price']}‚ÇΩ"
    )
    
    await callback.message.answer(
        f"{EMOJI['success']} *–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!*\n\n"
        f"–ü–∞–∫–µ—Ç: *{package['stars']} –∑–≤–µ–∑–¥*\n"
        f"–¶–µ–Ω–∞: *{package['price']}‚ÇΩ*\n\n"
        f"–° –≤–∞–º–∏ —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏.",
        parse_mode="Markdown"
    )
    await callback.answer()

# ========== –ü–û–ö–£–ü–ö–ê PREMIUM ==========
@dp.callback_query(F.data == "buy_premium")
async def buy_premium_handler(callback: CallbackQuery, state: FSMContext):
    """–ü–æ–∫—É–ø–∫–∞ Telegram Premium"""
    await state.set_state(UserStates.buy_premium)
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    builder = InlineKeyboardBuilder()
    
    # –ë–µ–∑ –≤—Ö–æ–¥–∞ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç
    builder.row(InlineKeyboardButton(
        text="‚Ä∞ –ë–µ–∑ –≤—Ö–æ–¥–∞ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç",
        callback_data="premium_header"
    ))
    
    no_login = db.get_premium_prices('no_login')
    for item in no_login:
        builder.row(InlineKeyboardButton(
            text=f"{item['period']} - {item['price']}$",
            callback_data=f"premium_no_{item['id']}"
        ))
    
    # –° –≤—ã—Ö–æ–¥–æ–º –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç
    builder.row(InlineKeyboardButton(
        text="‚Ä∞ –° –≤—ã—Ö–æ–¥–æ–º –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç",
        callback_data="premium_header"
    ))
    
    with_login = db.get_premium_prices('with_login')
    for item in with_login:
        builder.row(InlineKeyboardButton(
            text=f"{item['period']} - {item['price']}$",
            callback_data=f"premium_with_{item['id']}"
        ))
    
    builder.row(InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    
    text = f"""
    {EMOJI['premium']} *Telegram Premium* {EMOJI['premium']}
    
    üëë *–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Premium:*
    ‚Ä¢ üöÄ –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã
    ‚Ä¢ üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–æ 4 –ì–ë
    ‚Ä¢ üé≠ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—Ç–∏–∫–µ—Ä—ã
    ‚Ä¢ ‚ú® –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä–∫–∏
    ‚Ä¢ üî• –£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    ‚Ä¢ üé® –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    
    üíé *–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏:*
    ‚Ä¢ ‚Ä∞ –ë–µ–∑ –≤—Ö–æ–¥–∞ - –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    ‚Ä¢ ‚Ä∞ –° –≤—ã—Ö–æ–¥–æ–º - –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–∞ –≤–∞—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ
    """
    
    await callback.message.answer(
        text,
        reply_markup=builder.as_markup(),
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.callback_query(F.data.startswith("premium_"))
async def select_premium_callback(callback: CallbackQuery):
    """–í—ã–±–æ—Ä –ø–∞–∫–µ—Ç–∞ Premium"""
    if callback.data == "premium_header":
        await callback.answer()
        return
    
    # –†–∞–∑–±–∏—Ä–∞–µ–º callback_data
    parts = callback.data.split("_")
    if len(parts) >= 3:
        price_type = parts[1]  # no –∏–ª–∏ with
        price_id = int(parts[2])
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–∫–µ—Ç–µ
        premium_prices = db.get_premium_prices()
        package = next((p for p in premium_prices if p['id'] == price_id), None)
        
        if not package:
            await callback.answer("‚ùå –ü–∞–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)
            return
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        user_data = {
            'id': callback.from_user.id,
            'username': callback.from_user.username or f"user_{callback.from_user.id}"
        }
        
        await send_support_notification(
            order_id=price_id,
            user_data=user_data,
            order_type='premium',
            details=f"{package['type']} - {package['period']} - {package['price']}$"
        )
        
        await callback.message.answer(
            f"{EMOJI['success']} *–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!*\n\n"
            f"–¢–∏–ø: *Telegram Premium*\n"
            f"–ü–µ—Ä–∏–æ–¥: *{package['period']}*\n"
            f"–¶–µ–Ω–∞: *{package['price']}$*\n"
            f"–¢–∏–ø –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: *{'–ë–µ–∑ –≤—Ö–æ–¥–∞' if package['type'] == 'no_login' else '–° –≤—ã—Ö–æ–¥–æ–º'}*\n\n"
            f"–° –≤–∞–º–∏ —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä.",
            parse_mode="Markdown"
        )
    
    await callback.answer()

# ========== –ê–£–ö–¶–ò–û–ù ==========
@dp.callback_query(F.data == "auction")
async def auction_handler(callback: CallbackQuery, state: FSMContext):
    """–ê—É–∫—Ü–∏–æ–Ω"""
    await state.set_state(UserStates.auction_menu)
    
    # –ü–æ–ª—É—á–∞–µ–º –∞—É–∫—Ü–∏–æ–Ω—ã
    auctions = db.get_auctions()
    
    text = f"""
    {EMOJI['auction']} *–ê–£–ö–¶–ò–û–ù –ü–û–î–ê–†–ö–û–í* {EMOJI['auction']}
    
    üéâ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω!*
    
    üìã *–ü—Ä–∞–≤–∏–ª–∞ —É—á–∞—Å—Ç–∏—è:*
    1. –í—ã–±–µ—Ä–∏—Ç–µ –ª–æ—Ç –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –Ω–∏–∂–µ
    2. –û–ø–ª–∞—Ç–∏—Ç–µ —É—á–∞—Å—Ç–∏–µ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
    3. –î–æ–∂–¥–∏—Ç–µ—Å—å –Ω–∞—á–∞–ª–∞ –∞—É–∫—Ü–∏–æ–Ω–∞
    4. –£—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ —Ç–æ—Ä–≥–∞—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏!
    
    üèÜ *–°—Ç–æ–ª–±—Ü—ã —Ç–∞–±–ª–∏—Ü—ã:*
    ‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ - –∏–º—è –∞—É–∫—Ü–∏–æ–Ω–∞
    ‚Ä¢ –í—Ä–µ–º—è - –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
    ‚Ä¢ –í–∏–¥ - —Ç–∏–ø –∞—É–∫—Ü–∏–æ–Ω–∞
    ‚Ä¢ –¶–µ–Ω–∞ - —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—á–∞—Å—Ç–∏—è
    ‚Ä¢ –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å - –∫–Ω–æ–ø–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞
    
    ‚ö° *–£—á–∞—Å—Ç–≤—É–π—Ç–µ –∏ –≤—ã–∏–≥—Ä—ã–≤–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏!*
    """
    
    # –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É 5x5
    builder = InlineKeyboardBuilder()
    
    # –ó–∞–≥–æ–ª–æ–≤–∫–∏
    headers = ["–ù–∞–∑–≤–∞–Ω–∏–µ", "–í—Ä–µ–º—è", "–í–∏–¥", "–¶–µ–Ω–∞", "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å"]
    for header in headers:
        builder.button(text=header, callback_data="header")
    
    builder.adjust(5)
    
    # 25 —Å—Ç—Ä–æ–∫ (5x5)
    for i in range(25):
        if i < len(auctions):
            auction = auctions[i]
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
            start_time = auction['start_time']
            if start_time:
                try:
                    dt = datetime.fromisoformat(start_time.replace('Z', '+00:00'))
                    time_str = dt.strftime('%d.%m %H:%M')
                except:
                    time_str = start_time[:10]
            else:
                time_str = "-"
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É
            price = auction['entry_price']
            price_str = f"{price}$" if price and price > 0 else "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ"
            
            row = [
                auction['name'][:10] if auction['name'] else "-",
                time_str,
                auction['type'] or "-",
                price_str,
                "üéØ –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å"
            ]
            callback_suffix = f"auction_{auction['id']}"
        else:
            row = ["-", "-", "-", "-", "‚ûï –î–æ–±–∞–≤–∏—Ç—å"]
            callback_suffix = f"empty_{i}"
        
        for j, cell in enumerate(row):
            callback_data = f"auction_cell_{i}_{j}_{callback_suffix}"
            builder.button(text=cell, callback_data=callback_data)
        
        builder.adjust(5)
    
    # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    builder.row(
        InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data="back_to_main"),
        InlineKeyboardButton(text=f"{EMOJI['home']} –ì–ª–∞–≤–Ω–∞—è", callback_data="main_menu")
    )
    
    await callback.message.answer_photo(
        photo="https://via.placeholder.com/600x400/ff5722/FFFFFF?text=Auction+Live",
        caption=text,
        reply_markup=builder.as_markup(),
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.callback_query(F.data.startswith("auction_cell_"))
async def auction_cell_handler(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —è—á–µ–π–∫–µ –∞—É–∫—Ü–∏–æ–Ω–∞"""
    parts = callback.data.split("_")
    if len(parts) >= 6:
        row = int(parts[3])
        col = int(parts[4])
        auction_info = parts[5]
        
        if auction_info.startswith("auction_"):
            auction_id = int(auction_info.split("_")[1])
            
            # –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å" (5-—è –∫–æ–ª–æ–Ω–∫–∞)
            if col == 4:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                auction = db.get_auction_by_id(auction_id)
                if not auction:
                    await callback.answer("‚ùå –ê—É–∫—Ü–∏–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)
                    return
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —É—á–∞—Å—Ç–∏—è
                if auction['promo_code']:
                    await callback.answer("‚ÑπÔ∏è –≠—Ç–æ—Ç –∞—É–∫—Ü–∏–æ–Ω —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥", show_alert=True)
                    
                    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥
                    keyboard = InlineKeyboardMarkup(inline_keyboard=[
                        [InlineKeyboardButton(text="üîë –í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥", callback_data=f"auction_promo_{auction_id}")],
                        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="auction")]
                    ])
                    
                    await callback.message.answer(
                        f"{EMOJI['lock']} *–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–º–æ–∫–æ–¥*\n\n"
                        f"–î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∞—É–∫—Ü–∏–æ–Ω–µ '{auction['name']}' "
                        f"–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥.",
                        reply_markup=keyboard,
                        parse_mode="Markdown"
                    )
                    return
                
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∏
                success = db.add_auction_participant(
                    auction_id=auction_id,
                    user_id=callback.from_user.id,
                    username=callback.from_user.username or f"user_{callback.from_user.id}"
                )
                
                if success:
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º
                    user_data = {
                        'id': callback.from_user.id,
                        'username': callback.from_user.username or f"user_{callback.from_user.id}"
                    }
                    
                    await send_auction_notification(auction_id, user_data)
                    
                    # –ü–ª–∞–Ω–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 5 –º–∏–Ω—É—Ç
                    if auction['start_time']:
                        try:
                            start_time = datetime.fromisoformat(auction['start_time'].replace('Z', '+00:00'))
                            await schedule_auction_notification(auction_id, auction['name'], start_time)
                        except:
                            pass
                    
                    await callback.message.answer(
                        f"{EMOJI['success']} *–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∞—É–∫—Ü–∏–æ–Ω—É!*\n\n"
                        f"üè∑Ô∏è *–ù–∞–∑–≤–∞–Ω–∏–µ:* {auction['name']}\n"
                        f"{EMOJI['time']} *–ù–∞—á–∞–ª–æ:* {auction['start_time'][:16] if auction['start_time'] else '–°–∫–æ—Ä–æ'}\n"
                        f"{EMOJI['money']} *–°—Ç–æ–∏–º–æ—Å—Ç—å —É—á–∞—Å—Ç–∏—è:* {'–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' if not auction['entry_price'] else f'{auction[\"entry_price\"]}$'}\n\n"
                        f"üí¨ *–ß—Ç–æ –¥–∞–ª—å—à–µ:*
                        1. –° –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –æ–ø–ª–∞—Ç—ã (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
                        2. –í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 5 –º–∏–Ω—É—Ç –¥–æ –Ω–∞—á–∞–ª–∞
                        3. –í–æ –≤—Ä–µ–º—è –∞—É–∫—Ü–∏–æ–Ω–∞ –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å—Ç–∞–≤–æ–∫",
                        parse_mode="Markdown"
                    )
                else:
                    await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∞—É–∫—Ü–∏–æ–Ω—É", show_alert=True)
        else:
            await callback.answer("‚ÑπÔ∏è –≠—Ç–æ –ø—É—Å—Ç–∞—è —è—á–µ–π–∫–∞", show_alert=True)
    
    await callback.answer()

@dp.callback_query(F.data.startswith("auction_promo_"))
async def auction_promo_handler(callback: CallbackQuery, state: FSMContext):
    """–í–≤–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –¥–ª—è –∞—É–∫—Ü–∏–æ–Ω–∞"""
    auction_id = int(callback.data.split("_")[2])
    
    await state.set_state(UserStates.waiting_promo)
    await state.update_data(auction_id=auction_id)
    
    await callback.message.answer(
        f"{EMOJI['lock']} *–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥:*\n\n"
        f"–ü—Ä–æ–º–æ–∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        f"‚Ä¢ –°–ª–æ–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: START, PROMO)\n"
        f"‚Ä¢ XXX-XXX (–Ω–∞–ø—Ä–∏–º–µ—Ä: ABC-123)\n\n"
        f"–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥:",
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.message(UserStates.waiting_promo)
async def process_promo_code(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
    data = await state.get_data()
    auction_id = data.get('auction_id')
    
    if not auction_id:
        await message.answer(f"{EMOJI['error']} –û—à–∏–±–∫–∞: –∞—É–∫—Ü–∏–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
        await state.clear()
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –∞—É–∫—Ü–∏–æ–Ω
    auction = db.get_auction_by_id(auction_id)
    if not auction:
        await message.answer(f"{EMOJI['error']} –ê—É–∫—Ü–∏–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
        await state.clear()
        return
    
    promo_code = message.text.strip().upper()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥
    if auction['promo_code'] and promo_code == auction['promo_code']:
        # –ü—Ä–æ–º–æ–∫–æ–¥ –≤–µ—Ä–Ω—ã–π, –¥–æ–±–∞–≤–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
        success = db.add_auction_participant(
            auction_id=auction_id,
            user_id=message.from_user.id,
            username=message.from_user.username or f"user_{message.from_user.id}"
        )
        
        if success:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º
            user_data = {
                'id': message.from_user.id,
                'username': message.from_user.username or f"user_{message.from_user.id}"
            }
            
            await send_auction_notification(auction_id, user_data)
            
            # –ü–ª–∞–Ω–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 5 –º–∏–Ω—É—Ç
            if auction['start_time']:
                try:
                    start_time = datetime.fromisoformat(auction['start_time'].replace('Z', '+00:00'))
                    await schedule_auction_notification(auction_id, auction['name'], start_time)
                except:
                    pass
            
            await message.answer(
                f"{EMOJI['success']} *–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–Ω—è—Ç! –í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∞—É–∫—Ü–∏–æ–Ω—É.*\n\n"
                f"üè∑Ô∏è *–ù–∞–∑–≤–∞–Ω–∏–µ:* {auction['name']}\n"
                f"üîë *–ü—Ä–æ–º–æ–∫–æ–¥:* {promo_code}\n\n"
                f"–° –≤–∞–º–∏ —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä.",
                parse_mode="Markdown"
            )
        else:
            await message.answer(f"{EMOJI['error']} –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∞—É–∫—Ü–∏–æ–Ω—É")
    else:
        await message.answer(
            f"{EMOJI['error']} *–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥!*\n\n"
            f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞:\n"
            f"‚Ä¢ –†–µ–≥–∏—Å—Ç—Ä –±—É–∫–≤ (ABC-123)\n"
            f"‚Ä¢ –§–æ—Ä–º–∞—Ç (XXX-XXX –∏–ª–∏ —Å–ª–æ–≤–æ)\n\n"
            f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:"
        )
        # –û—Å—Ç–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
    
    await state.clear()

# ========== –ê–î–ú–ò–ù: –£–ü–†–ê–í–õ–ï–ù–ò–ï –ê–£–ö–¶–ò–û–ù–û–ú ==========
@dp.callback_query(F.data == "admin_auction_manage")
async def admin_auction_manage_handler(callback: CallbackQuery):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–∞–º–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!", show_alert=True)
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –∞—É–∫—Ü–∏–æ–Ω—ã
    auctions = db.get_auctions()
    
    if not auctions:
        await callback.message.answer(
            f"{EMOJI['auction']} *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–∞–º–∏*\n\n"
            f"–ê–∫—Ç–∏–≤–Ω—ã—Ö –∞—É–∫—Ü–∏–æ–Ω–æ–≤ –Ω–µ—Ç.\n\n"
            f"–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞—É–∫—Ü–∏–æ–Ω —á–µ—Ä–µ–∑ –º–µ–Ω—é '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É–∫—Ü–∏–æ–Ω–∞'",
            parse_mode="Markdown"
        )
        return
    
    # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞—É–∫—Ü–∏–æ–Ω–æ–≤
    text = f"{EMOJI['auction']} *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–∞–º–∏*\n\n"
    for auction in auctions:
        participants = db.get_auction_participant_count(auction['id'])
        text += f"üî® *{auction['name']}*\n"
        text += f"   ID: #{auction['id']}\n"
        text += f"   –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {participants}\n"
        text += f"   –°—Ç–∞—Ç—É—Å: {auction['status']}\n\n"
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞—É–∫—Ü–∏–æ–Ω–∞
    builder = InlineKeyboardBuilder()
    
    for auction in auctions:
        builder.row(InlineKeyboardButton(
            text=f"üî® {auction['name'][:15]}",
            callback_data=f"admin_auction_select_{auction['id']}"
        ))
    
    builder.row(InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data="admin_menu"))
    
    await callback.message.answer(
        text,
        reply_markup=builder.as_markup(),
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.callback_query(F.data.startswith("admin_auction_select_"))
async def admin_select_auction_handler(callback: CallbackQuery):
    """–í—ã–±–æ—Ä –∞—É–∫—Ü–∏–æ–Ω–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"""
    auction_id = int(callback.data.split("_")[-1])
    
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!", show_alert=True)
        return
    
    auction = db.get_auction_by_id(auction_id)
    if not auction:
        await callback.answer("‚ùå –ê—É–∫—Ü–∏–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)
        return
    
    participants = db.get_auction_participants(auction_id)
    items = db.get_auction_items(auction_id)
    
    text = f"""
    {EMOJI['auction']} *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–æ–º* #{auction_id}
    
    üè∑Ô∏è *–ù–∞–∑–≤–∞–Ω–∏–µ:* {auction['name']}
    ‚è∞ *–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:* {auction['start_time']}
    üìä *–¢–∏–ø:* {auction['type']}
    üí∞ *–¶–µ–Ω–∞ —É—á–∞—Å—Ç–∏—è:* {'–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' if not auction['entry_price'] else f'{auction[\"entry_price\"]}$'}
    üîë *–ü—Ä–æ–º–æ–∫–æ–¥:* {auction['promo_code'] or '–ù–µ—Ç'}
    üë• *–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:* {len(participants)}
    üéÅ *–¢–æ–≤–∞—Ä–æ–≤:* {len(items)}
    üìà *–°—Ç–∞—Ç—É—Å:* {auction['status']}
    """
    
    await callback.message.answer(
        text,
        reply_markup=get_auction_management_keyboard(auction_id),
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.callback_query(F.data.startswith("auction_participants_"))
async def auction_participants_handler(callback: CallbackQuery):
    """–ü—Ä–æ—Å–º–æ—Ç—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∞—É–∫—Ü–∏–æ–Ω–∞"""
    auction_id = int(callback.data.split("_")[-1])
    
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!", show_alert=True)
        return
    
    participants = db.get_auction_participants(auction_id)
    
    if not participants:
        text = f"{EMOJI['people']} *–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∞—É–∫—Ü–∏–æ–Ω–∞*\n\n–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç."
    else:
        text = f"{EMOJI['people']} *–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∞—É–∫—Ü–∏–æ–Ω–∞*\n\n"
        for i, participant in enumerate(participants, 1):
            paid_status = "‚úÖ" if participant['paid'] else "‚ùå"
            text += f"{i}. @{participant['username']} {paid_status}\n"
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data=f"admin_auction_select_{auction_id}")]
    ])
    
    await callback.message.answer(
        text,
        reply_markup=keyboard,
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.callback_query(F.data.startswith("auction_add_prize_"))
async def auction_add_prize_handler(callback: CallbackQuery, state: FSMContext):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–∞ –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω"""
    auction_id = int(callback.data.split("_")[-1])
    
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!", show_alert=True)
        return
    
    await state.set_state(AdminStates.set_auction_prize)
    await state.update_data(auction_id=auction_id)
    
    await callback.message.answer(
        f"{EMOJI['gift']} *–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–∞ –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω*\n\n"
        f"–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        f"`–ù–ê–ó–í–ê–ù–ò–ï –ü–†–ò–ó–ê | –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø –¶–ï–ù–ê`\n\n"
        f"–ü—Ä–∏–º–µ—Ä: `PlayStation 5 | 1000`\n\n"
        f"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö ($)",
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.message(AdminStates.set_auction_prize)
async def process_auction_prize(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –∏ —Ü–µ–Ω—ã –ø—Ä–∏–∑–∞"""
    data = await state.get_data()
    auction_id = data.get('auction_id')
    
    if not auction_id:
        await message.answer(f"{EMOJI['error']} –û—à–∏–±–∫–∞: –∞—É–∫—Ü–∏–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
        await state.clear()
        return
    
    # –ü–∞—Ä—Å–∏–º –≤–≤–æ–¥
    input_text = message.text.strip()
    if '|' not in input_text:
        await message.answer(
            f"{EMOJI['error']} *–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!*\n\n"
            f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç:\n"
            f"`–ù–ê–ó–í–ê–ù–ò–ï | –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø –¶–ï–ù–ê`\n\n"
            f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:"
        )
        return
    
    try:
        name_part, price_part = input_text.split('|', 1)
        name = name_part.strip()
        min_price = float(price_part.strip())
        
        await state.update_data(item_name=name, item_min_price=min_price)
        await state.set_state(AdminStates.set_auction_photo)
        
        await message.answer(
            f"{EMOJI['camera']} *–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –ø—Ä–∏–∑–∞*\n\n"
            f"–ù–∞–∑–≤–∞–Ω–∏–µ: *{name}*\n"
            f"–ú–∏–Ω. —Ü–µ–Ω–∞: *{min_price}$*\n\n"
            f"–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –ø—Ä–∏–∑–∞:",
            parse_mode="Markdown"
        )
        
    except ValueError:
        await message.answer(
            f"{EMOJI['error']} *–ù–µ–≤–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞!*\n\n"
            f"–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º.\n"
            f"–ü—Ä–∏–º–µ—Ä: `1000` –∏–ª–∏ `999.99`\n\n"
            f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:"
        )

@dp.message(AdminStates.set_auction_photo)
async def process_auction_photo(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –ø—Ä–∏–∑–∞"""
    if not message.photo:
        await message.answer(f"{EMOJI['error']} –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ")
        return
    
    data = await state.get_data()
    auction_id = data.get('auction_id')
    item_name = data.get('item_name')
    item_min_price = data.get('item_min_price')
    
    if not all([auction_id, item_name, item_min_price]):
        await message.answer(f"{EMOJI['error']} –û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –Ω–µ–ø–æ–ª–Ω—ã–µ")
        await state.clear()
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å file_id)
    photo_id = message.photo[-1].file_id
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –≤ –ë–î
    item_id = db.add_auction_item(
        auction_id=auction_id,
        name=item_name,
        min_price=item_min_price,
        photo_id=photo_id
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
    participants = db.get_auction_participants(auction_id)
    auction = db.get_auction_by_id(auction_id)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç
    await start_auction_countdown(auction_id, item_id, item_name, item_min_price, photo_id, participants)
    
    await message.answer(
        f"{EMOJI['success']} *–ü—Ä–∏–∑ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω!*\n\n"
        f"üéÅ *–ù–∞–∑–≤–∞–Ω–∏–µ:* {item_name}\n"
        f"üí∞ *–ú–∏–Ω. —Ü–µ–Ω–∞:* {item_min_price}$\n\n"
        f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.",
        parse_mode="Markdown"
    )
    
    await state.clear()

async def start_auction_countdown(auction_id: int, item_id: int, item_name: str, min_price: float, 
                                  photo_id: str, participants: List[Dict]):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç –¥–ª—è –∞—É–∫—Ü–∏–æ–Ω–∞"""
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    for participant in participants:
        try:
            await bot.send_photo(
                chat_id=participant['user_id'],
                photo=photo_id,
                caption=f"""
{EMOJI['warning']} *–í–ù–ò–ú–ê–ù–ò–ï, –ù–û–í–´–ô –¢–û–í–ê–†!*
{EMOJI['gift']} *{item_name}*
{EMOJI['money']} *–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞: {min_price}$*

–ß–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –Ω–∞—á–∏–Ω–∞–µ–º –∞—É–∫—Ü–∏–æ–Ω –Ω–∞ —ç—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫!
""",
                parse_mode="Markdown"
            )
        except Exception as e:
            logging.error(f"Error sending auction start to {participant['user_id']}: {e}")
    
    # –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç
    for i in range(5, 0, -1):
        await asyncio.sleep(1)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –Ω—É–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)
        for participant in participants:
            try:
                # –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
                pass
            except:
                pass
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞—É–∫—Ü–∏–æ–Ω
    await start_auction_bidding(auction_id, item_id, item_name, min_price, photo_id, participants)

async def start_auction_bidding(auction_id: int, item_id: int, item_name: str, min_price: float, 
                                photo_id: str, participants: List[Dict]):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ç–æ—Ä–≥–æ–≤"""
    current_price = min_price
    highest_bidder = None
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è —Å—Ç–∞–≤–æ–∫
    for participant in participants:
        try:
            await bot.send_photo(
                chat_id=participant['user_id'],
                photo=photo_id,
                caption=f"""
{EMOJI['fire']} *–ê–£–ö–¶–ò–û–ù –ù–ê–ß–ê–õ–°–Ø!*
{EMOJI['gift']} *{item_name}*
{EMOJI['money']} *–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: {current_price}$*

–î–µ–ª–∞–π—Ç–µ –≤–∞—à–∏ —Å—Ç–∞–≤–∫–∏!
""",
                reply_markup=get_auction_bidding_keyboard(auction_id),
                parse_mode="Markdown"
            )
        except Exception as e:
            logging.error(f"Error sending auction to {participant['user_id']}: {e}")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–∫—Ç–∏–≤–Ω–æ–º –∞—É–∫—Ü–∏–æ–Ω–µ
    active_auctions[auction_id] = {
        'item_id': item_id,
        'item_name': item_name,
        'current_price': current_price,
        'highest_bidder': highest_bidder,
        'photo_id': photo_id,
        'participants': [p['user_id'] for p in participants],
        'start_time': datetime.now()
    }

@dp.callback_query(F.data.startswith("bid_"))
async def bid_handler(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞–≤–∫–∏ –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω–µ"""
    parts = callback.data.split("_")
    if len(parts) >= 3:
        auction_id = int(parts[1])
        bid_amount = parts[2]
        
        if bid_amount == "custom":
            # –ó–∞–ø—Ä–æ—Å —Å–≤–æ–µ–π —Ü–µ–Ω—ã
            await callback.message.answer(
                f"{EMOJI['money']} *–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Å—Ç–∞–≤–∫—É:*\n\n"
                f"–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö ($)",
                parse_mode="Markdown"
            )
            # –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
            await callback.answer()
            return
        
        try:
            bid_value = int(bid_amount)
        except:
            await callback.answer("‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–∞–≤–∫–∞!", show_alert=True)
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∞—É–∫—Ü–∏–æ–Ω
        if auction_id not in active_auctions:
            await callback.answer("‚ùå –ê—É–∫—Ü–∏–æ–Ω –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω!", show_alert=True)
            return
        
        auction = active_auctions[auction_id]
        new_price = auction['current_price'] + bid_value
        
        # –î–µ–ª–∞–µ–º —Å—Ç–∞–≤–∫—É
        db.add_auction_bid(
            auction_id=auction_id,
            user_id=callback.from_user.id,
            username=callback.from_user.username or f"user_{callback.from_user.id}",
            bid_amount=new_price
        )
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        auction['current_price'] = new_price
        auction['highest_bidder'] = callback.from_user.id
        
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        for participant_id in auction['participants']:
            try:
                await bot.send_message(
                    chat_id=participant_id,
                    text=f"{EMOJI['bell']} *–ù–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞!*\n\n"
                         f"@{callback.from_user.username or '–£—á–∞—Å—Ç–Ω–∏–∫'} –ø–æ–≤—ã—Å–∏–ª —Å—Ç–∞–≤–∫—É –¥–æ *{new_price}$*",
                    parse_mode="Markdown"
                )
            except:
                pass
        
        await callback.answer(f"‚úÖ –í–∞—à–∞ —Å—Ç–∞–≤–∫–∞: {new_price}$")

# ========== –ê–î–ú–ò–ù: –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==========
@dp.callback_query(F.data == "admin_stats")
async def admin_stats_handler(callback: CallbackQuery):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!", show_alert=True)
        return
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ 30 –¥–Ω–µ–π
    stats = db.get_statistics(days=30)
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    stats_text = f"""
{EMOJI['stats']} *–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–û–¢–ê* {EMOJI['stats']}

üìä *–û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:*
üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}
üì¶ –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: {stats['total_orders']}
‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: {stats['completed_orders']}
üí∞ –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: {stats['total_revenue']:.2f}‚ÇΩ

üìà *–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ó–ê 30 –î–ù–ï–ô:*
üë§ –ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['period_stats']['new_users']}
üõí –ó–∞–∫–∞–∑–æ–≤: {stats['period_stats']['orders']}
üíµ –í—ã—Ä—É—á–∫–∞: {stats['period_stats']['revenue']:.2f}‚ÇΩ
üéÅ NFT –ø—Ä–æ–¥–∞–Ω–æ: {stats['period_stats']['nft_sold']}
‚≠ê Stars –ø—Ä–æ–¥–∞–Ω–æ: {stats['period_stats']['stars_sold']}
üëë Premium –ø—Ä–æ–¥–∞–Ω–æ: {stats['period_stats']['premium_sold']}

üìÖ *–°–†–ï–î–ù–ò–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò –í –î–ï–ù–¨:*
üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['period_stats']['new_users'] / stats['period_days']:.1f}
üõí –ó–∞–∫–∞–∑–æ–≤: {stats['period_stats']['orders'] / stats['period_days']:.1f}
üíµ –í—ã—Ä—É—á–∫–∞: {stats['period_stats']['revenue'] / stats['period_days']:.2f}‚ÇΩ
"""
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìÖ –ó–∞ —Å–µ–≥–æ–¥–Ω—è", callback_data="stats_today")],
        [InlineKeyboardButton(text="üìÜ –ó–∞ –Ω–µ–¥–µ–ª—é", callback_data="stats_week")],
        [InlineKeyboardButton(text="üìä –ó–∞ –º–µ—Å—è—Ü", callback_data="stats_month")],
        [InlineKeyboardButton(text="üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", callback_data="stats_users")],
        [InlineKeyboardButton(text="üõí –ó–∞–∫–∞–∑—ã", callback_data="stats_orders")],
        [InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data="admin_menu")]
    ])
    
    await callback.message.answer(
        stats_text,
        reply_markup=keyboard,
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.callback_query(F.data == "stats_today")
async def stats_today_handler(callback: CallbackQuery):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!", show_alert=True)
        return
    
    stats = db.get_statistics(days=1)
    
    stats_text = f"""
{EMOJI['stats']} *–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ó–ê –°–ï–ì–û–î–ù–Ø* {EMOJI['stats']}

üë• –ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['period_stats']['new_users']}
üõí –ó–∞–∫–∞–∑–æ–≤: {stats['period_stats']['orders']}
üíµ –í—ã—Ä—É—á–∫–∞: {stats['period_stats']['revenue']:.2f}‚ÇΩ
üéÅ NFT –ø—Ä–æ–¥–∞–Ω–æ: {stats['period_stats']['nft_sold']}
‚≠ê Stars –ø—Ä–æ–¥–∞–Ω–æ: {stats['period_stats']['stars_sold']}
üëë Premium –ø—Ä–æ–¥–∞–Ω–æ: {stats['period_stats']['premium_sold']}
"""
    
    await callback.message.answer(stats_text, parse_mode="Markdown")
    await callback.answer()

# ========== –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–ö–ê–ó–û–í –ê–î–ú–ò–ù–ê–ú–ò ==========
@dp.callback_query(F.data.startswith("order_take_"))
async def order_take_handler(callback: CallbackQuery):
    """–í–∑—è—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–æ–º"""
    order_id = int(callback.data.split("_")[-1])
    
    if not db.is_manager(callback.from_user.id):
        await callback.answer("‚ùå –¢–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –º–æ–≥—É—Ç –±—Ä–∞—Ç—å –∑–∞–∫–∞–∑—ã!", show_alert=True)
        return
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
    db.update_order_status(
        order_id=order_id,
        status='b',
        admin_id=callback.from_user.id,
        admin_username=callback.from_user.username or f"user_{callback.from_user.id}"
    )
    
    await callback.answer(f"‚úÖ –ó–∞–∫–∞–∑ #{order_id} –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É!")

@dp.callback_query(F.data.startswith("order_complete_"))
async def order_complete_handler(callback: CallbackQuery):
    """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞"""
    order_id = int(callback.data.split("_")[-1])
    
    if not db.is_manager(callback.from_user.id):
        await callback.answer("‚ùå –¢–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –º–æ–≥—É—Ç –∑–∞–≤–µ—Ä—à–∞—Ç—å –∑–∞–∫–∞–∑—ã!", show_alert=True)
        return
    
    db.update_order_status(order_id, 's')
    
    await callback.answer(f"‚úÖ –ó–∞–∫–∞–∑ #{order_id} –∑–∞–≤–µ—Ä—à–µ–Ω!")

@dp.callback_query(F.data.startswith("order_spam_"))
async def order_spam_handler(callback: CallbackQuery):
    """–ü–æ–º–µ—Ç–∏—Ç—å –∑–∞–∫–∞–∑ –∫–∞–∫ —Å–ø–∞–º"""
    order_id = int(callback.data.split("_")[-1])
    
    if not db.is_manager(callback.from_user.id):
        await callback.answer("‚ùå –¢–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –º–æ–≥—É—Ç –æ—Ç–º–µ—á–∞—Ç—å —Å–ø–∞–º!", show_alert=True)
        return
    
    db.update_order_status(order_id, 'z')
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    order_data = db.get_order(order_id)
    if order_data:
        try:
            await bot.send_message(
                chat_id=order_data['user_id'],
                text=f"{EMOJI['error']} *–û—à–∏–±–∫–∞. –°–≤—è–∑—å —Å –±–∞–∑–æ–π...*"
            )
        except:
            pass
    
    await callback.answer(f"üö´ –ó–∞–∫–∞–∑ #{order_id} –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ —Å–ø–∞–º!")

@dp.callback_query(F.data.startswith("order_no_pay_"))
async def order_no_pay_handler(callback: CallbackQuery):
    """–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–π"""
    order_id = int(callback.data.split("_")[-1])
    
    if not db.is_manager(callback.from_user.id):
        await callback.answer("‚ùå –¢–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –º–æ–≥—É—Ç –æ—Ç–º–µ—á–∞—Ç—å –Ω–µ–æ–ø–ª–∞—Ç—É!", show_alert=True)
        return
    
    db.update_order_status(order_id, 'g')
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    order_data = db.get_order(order_id)
    if order_data:
        try:
            await bot.send_message(
                chat_id=order_data['user_id'],
                text=f"{EMOJI['error']} *–í–´ –Ω–µ –æ–ø–ª–∞—Ç–∏–ª–∏ –∑–∞–∫–∞–∑. –û–ø–ª–∞—Ç–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.*"
            )
        except:
            pass
    
    await callback.answer(f"üí≥ –ó–∞–∫–∞–∑ #{order_id} - –Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ!")

@dp.callback_query(F.data.startswith("order_restart_"))
async def order_restart_handler(callback: CallbackQuery):
    """–†–µ—Å—Ç–∞—Ä—Ç –∑–∞–∫–∞–∑–∞"""
    order_id = int(callback.data.split("_")[-1])
    
    if not db.is_manager(callback.from_user.id):
        await callback.answer("‚ùå –¢–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –º–æ–≥—É—Ç —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã!", show_alert=True)
        return
    
    db.update_order_status(order_id, 'a', None, None)
    
    await callback.answer(f"üîÑ –ó–∞–∫–∞–∑ #{order_id} —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤–∞–Ω!")

# ========== –ü–û–î–î–ï–†–ñ–ö–ê –ò –û–¢–ó–´–í–´ ==========
@dp.callback_query(F.data == "support")
async def support_handler(callback: CallbackQuery, state: FSMContext):
    """–ü–æ–¥–¥–µ—Ä–∂–∫–∞"""
    await state.set_state(SupportStates.waiting_message)
    await state.update_data(order_type="support")
    
    await callback.message.answer(
        f"{EMOJI['support']} *–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏* {EMOJI['support']}\n\n"
        f"–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –≤–æ–ø—Ä–æ—Å, –∏ –º—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–º–æ–∂–µ–º!\n\n"
        f"üìù *–ß—Ç–æ –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å:*\n"
        f"‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–∫–∞–∑–æ–º\n"
        f"‚Ä¢ –í–æ–ø—Ä–æ—Å—ã –ø–æ –æ–ø–ª–∞—Ç–µ\n"
        f"‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏\n"
        f"‚Ä¢ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é\n\n"
        f"‚è± *–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 15-30 –º–∏–Ω—É—Ç*",
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.callback_query(F.data == "reviews")
async def reviews_handler(callback: CallbackQuery):
    """–û—Ç–∑—ã–≤—ã"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìñ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã", url="https://t.me/your_reviews_channel")],
        [InlineKeyboardButton(text="‚úèÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤", callback_data="write_review")],
        [InlineKeyboardButton(text=f"{EMOJI['back']} –ù–∞–∑–∞–¥", callback_data="back_to_main")]
    ])
    
    await callback.message.answer(
        f"{EMOJI['reviews']} *–û—Ç–∑—ã–≤—ã* {EMOJI['reviews']}\n\n"
        f"üåü *–ß–∏—Ç–∞–π—Ç–µ –æ—Ç–∑—ã–≤—ã —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π!*\n\n"
        f"‚Ä¢ üìñ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã - –ø–µ—Ä–µ—Ö–æ–¥ –≤ –∫–∞–Ω–∞–ª —Å –æ—Ç–∑—ã–≤–∞–º–∏\n"
        f"‚Ä¢ ‚úèÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤ - –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –æ–ø—ã—Ç–æ–º",
        reply_markup=keyboard,
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.callback_query(F.data == "write_review")
async def write_review_handler(callback: CallbackQuery, state: FSMContext):
    """–ù–∞–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞"""
    await state.set_state(SupportStates.waiting_message)
    await state.update_data(order_type="review")
    
    await callback.message.answer(
        f"{EMOJI['reviews']} *–ù–∞–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞*\n\n"
        f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤ –æ –Ω–∞—à–µ–π —Ä–∞–±–æ—Ç–µ.\n"
        f"–û–Ω –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –≤ –Ω–∞—à–µ–º –∫–∞–Ω–∞–ª–µ.\n\n"
        f"–ú–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ –∏–ª–∏ —Ç–µ–∫—Å—Ç.",
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.message(SupportStates.waiting_message)
async def process_support_message(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É"""
    data = await state.get_data()
    order_type = data.get('order_type', 'support')
    
    user_data = {
        'id': message.from_user.id,
        'username': message.from_user.username or f"user_{message.from_user.id}"
    }
    
    await send_support_notification(
        order_id=0,  # –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –≤ —Ñ—É–Ω–∫—Ü–∏–∏
        user_data=user_data,
        order_type=order_type,
        details=message.text[:500]
    )
    
    if order_type == 'review':
        await message.answer(
            f"{EMOJI['success']} *–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤!*\n\n"
            f"–û–Ω –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –ø–æ—Å–ª–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏.",
            parse_mode="Markdown"
        )
    else:
        await message.answer(
            f"{EMOJI['success']} *–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!*\n\n"
            f"–° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n"
            f"‚è± –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 15-30 –º–∏–Ω—É—Ç",
            parse_mode="Markdown"
        )
    
    await state.clear()

# ========== –§–û–ù–û–í–´–ï –ó–ê–î–ê–ß–ò ==========
async def check_subscriptions_daily():
    """–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –≤ 12:00 –ú–°–ö"""
    while True:
        try:
            now = datetime.now()
            # 12:00 –ú–°–ö = 9:00 UTC
            if now.hour == 9 and now.minute == 0:
                # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                # –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                pass
        except Exception as e:
            logging.error(f"Error in daily subscription check: {e}")
        
        await asyncio.sleep(60)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

async def check_auction_start_times():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ –∞—É–∫—Ü–∏–æ–Ω–æ–≤ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    while True:
        try:
            now = datetime.now()
            five_minutes_later = now + timedelta(minutes=5)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É–∫—Ü–∏–æ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–Ω—É—Ç—Å—è —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
            auctions = db.get_auctions()
            
            for auction in auctions:
                if auction['start_time'] and not auction['notified_5min']:
                    try:
                        start_time = datetime.fromisoformat(auction['start_time'].replace('Z', '+00:00'))
                        
                        if now <= start_time <= five_minutes_later:
                            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                            participants = db.get_auction_participants(auction['id'])
                            
                            for participant in participants:
                                try:
                                    await bot.send_message(
                                        chat_id=participant['user_id'],
                                        text=f"{EMOJI['bell']} *–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!*\n\n"
                                             f"–ê—É–∫—Ü–∏–æ–Ω '{auction['name']}' –Ω–∞—á–Ω–µ—Ç—Å—è —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç!\n"
                                             f"–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ —É—á–∞—Å—Ç–∏—é.",
                                        parse_mode="Markdown"
                                    )
                                except:
                                    pass
                            
                            # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–Ω—ã–π
                            db.cursor.execute('UPDATE auctions SET notified_5min = 1 WHERE id = ?', (auction['id'],))
                            db.conn.commit()
                            
                    except Exception as e:
                        logging.error(f"Error checking auction {auction['id']}: {e}")
                        
        except Exception as e:
            logging.error(f"Error in auction time check: {e}")
        
        await asyncio.sleep(60)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========
async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞"""
    # –î–æ–±–∞–≤–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤ –ë–î –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
    try:
        db.add_staff(OWNER_ID, "Timyr2011", "owner", OWNER_ID)
    except:
        pass
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
    asyncio.create_task(check_subscriptions_daily())
    asyncio.create_task(check_auction_start_times())
    
    logging.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    
    await dp.start_polling(bot)

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logging.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    finally:
        db.close()
