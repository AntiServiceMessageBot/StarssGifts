import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters
import json
import os

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –î–∞–Ω–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø–æ–¥–∞—Ä–∫–æ–≤ (–º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö)
CATALOG = {
    "popular": {
        "name": "üéÅ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏",
        "items": [
            {"id": 1, "name": "–°–º–∞—Ä—Ç—Ñ–æ–Ω iPhone 15", "price": 79990, "category": "electronics", "image": "iphone.jpg"},
            {"id": 2, "name": "–ù–∞—É—à–Ω–∏–∫–∏ Sony WH-1000XM5", "price": 29990, "category": "electronics", "image": "sony.jpg"},
            {"id": 3, "name": "–£–º–Ω—ã–µ —á–∞—Å—ã Apple Watch", "price": 34990, "category": "electronics", "image": "watch.jpg"},
        ]
    },
    "electronics": {
        "name": "üì± –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞",
        "items": [
            {"id": 1, "name": "–°–º–∞—Ä—Ç—Ñ–æ–Ω iPhone 15", "price": 79990, "category": "electronics", "image": "iphone.jpg"},
            {"id": 2, "name": "–ù–∞—É—à–Ω–∏–∫–∏ Sony WH-1000XM5", "price": 29990, "category": "electronics", "image": "sony.jpg"},
            {"id": 4, "name": "–ù–æ—É—Ç–±—É–∫ MacBook Air", "price": 89990, "category": "electronics", "image": "macbook.jpg"},
            {"id": 5, "name": "–ü–ª–∞–Ω—à–µ—Ç iPad Pro", "price": 74990, "category": "electronics", "image": "ipad.jpg"},
        ]
    },
    "books": {
        "name": "üìö –ö–Ω–∏–≥–∏",
        "items": [
            {"id": 6, "name": "–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", "price": 890, "category": "books", "image": "book1.jpg"},
            {"id": 7, "name": "–ë–∏–∑–Ω–µ—Å-–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", "price": 1290, "category": "books", "image": "book2.jpg"},
        ]
    },
    "clothes": {
        "name": "üëï –û–¥–µ–∂–¥–∞",
        "items": [
            {"id": 8, "name": "–§—É—Ç–±–æ–ª–∫–∞ –ø—Ä–µ–º–∏—É–º", "price": 2990, "category": "clothes", "image": "tshirt.jpg"},
            {"id": 9, "name": "–°–≤–∏—Ç–µ—Ä —Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã", "price": 4990, "category": "clothes", "image": "sweater.jpg"},
        ]
    },
    "experience": {
        "name": "üé™ –í–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è",
        "items": [
            {"id": 10, "name": "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤ –°–ü–ê", "price": 5990, "category": "experience", "image": "spa.jpg"},
            {"id": 11, "name": "–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å –ø–æ –∫—É–ª–∏–Ω–∞—Ä–∏–∏", "price": 3990, "category": "experience", "image": "cooking.jpg"},
        ]
    }
}

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –∫–æ—Ä–∑–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ë–î)
user_carts = {}

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    welcome_text = f"""
üëã –ü—Ä–∏–≤–µ—Ç, {user.first_name}!

üéÅ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–∞—Ç–∞–ª–æ–≥ –ø–æ–¥–∞—Ä–∫–æ–≤! 
–ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥–µ—Ç–µ –∏–¥–µ–∏ –¥–ª—è –ø–æ–¥–∞—Ä–∫–æ–≤ –Ω–∞ –ª—é–±–æ–π —Å–ª—É—á–∞–π.

üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/catalog - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –ø–æ–¥–∞—Ä–∫–æ–≤
/cart - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ—Ä–∑–∏–Ω—É
/help - –ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞
    """
    
    keyboard = [
        [InlineKeyboardButton("üéÅ –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥", callback_data='open_catalog')],
        [InlineKeyboardButton("üõí –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞", callback_data='view_cart')],
        [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data='help')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(welcome_text, reply_markup=reply_markup)

# –ö–æ–º–∞–Ω–¥–∞ /catalog
async def catalog(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await show_categories(update, context)

# –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
async def show_categories(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = []
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    for category_id, category_data in CATALOG.items():
        keyboard.append([InlineKeyboardButton(
            category_data['name'], 
            callback_data=f'category_{category_id}'
        )])
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    keyboard.append([InlineKeyboardButton("üõí –ö–æ—Ä–∑–∏–Ω–∞", callback_data='view_cart')])
    keyboard.append([InlineKeyboardButton("üîç –ü–æ–∏—Å–∫ –ø–æ–¥–∞—Ä–∫–æ–≤", callback_data='search_gifts')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    text = "üìÇ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ–¥–∞—Ä–∫–æ–≤:"
    
    if update.callback_query:
        await update.callback_query.edit_message_text(text, reply_markup=reply_markup)
    else:
        await update.message.reply_text(text, reply_markup=reply_markup)

# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
async def show_category_items(update: Update, context: ContextTypes.DEFAULT_TYPE, category_id: str):
    category = CATALOG.get(category_id)
    if not category:
        await update.callback_query.answer("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        return
    
    items = category['items']
    text = f"üéÅ *{category['name']}*\n\n"
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
    for idx, item in enumerate(items, 1):
        text += f"{idx}. *{item['name']}*\n"
        text += f"   üí∞ –¶–µ–Ω–∞: {item['price']:,} —Ä—É–±.\n"
        text += f"   [–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É](callback:add_{item['id']}_{category_id})\n\n"
    
    keyboard = [
        [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É", switch_inline_query_current_chat=f"add_{category_id}")],
        [InlineKeyboardButton("üìÇ –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º", callback_data='back_to_categories')],
        [InlineKeyboardButton("üõí –ö–æ—Ä–∑–∏–Ω–∞", callback_data='view_cart')]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.callback_query.edit_message_text(
        text, 
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

# –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞
async def show_item_details(update: Update, context: ContextTypes.DEFAULT_TYPE, item_id: int, category_id: str):
    category = CATALOG.get(category_id)
    if not category:
        await update.callback_query.answer("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return
    
    item = next((i for i in category['items'] if i['id'] == item_id), None)
    if not item:
        await update.callback_query.answer("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return
    
    text = f"""
üéÅ *{item['name']}*

üí∞ *–¶–µ–Ω–∞:* {item['price']:,} —Ä—É–±.
üìÅ *–ö–∞—Ç–µ–≥–æ—Ä–∏—è:* {category['name']}

üìù *–û–ø–∏—Å–∞–Ω–∏–µ:*
–ò–¥–µ–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è –ª—é–±–æ–≥–æ —Å–ª—É—á–∞—è! 
–í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—è –æ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è.

üéØ *–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:*
‚Ä¢ –ü—Ä–µ–º–∏—É–º –∫–∞—á–µ—Å—Ç–≤–æ
‚Ä¢ –ì–∞—Ä–∞–Ω—Ç–∏—è 1 –≥–æ–¥
‚Ä¢ –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç–∞
    """
    
    keyboard = [
        [
            InlineKeyboardButton("üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É", callback_data=f'add_to_cart_{item_id}_{category_id}'),
            InlineKeyboardButton("‚≠ê –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ", callback_data=f'favorite_{item_id}')
        ],
        [
            InlineKeyboardButton("üìÇ –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", callback_data=f'category_{category_id}'),
            InlineKeyboardButton("üõí –ö–æ—Ä–∑–∏–Ω–∞", callback_data='view_cart')
        ]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.callback_query.edit_message_text(
        text, 
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

# –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É
async def show_cart(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cart = user_carts.get(user_id, {})
    
    if not cart:
        text = "üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!\n\n–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ç–∞–ª–æ–≥, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–∫–∏."
        keyboard = [
            [InlineKeyboardButton("üéÅ –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥", callback_data='open_catalog')]
        ]
    else:
        total = 0
        text = "üõí *–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞:*\n\n"
        
        for item_id, quantity in cart.items():
            # –ù–∞—Ö–æ–¥–∏–º —Ç–æ–≤–∞—Ä –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
            item = None
            category_id = None
            for cat_id, cat_data in CATALOG.items():
                for itm in cat_data['items']:
                    if itm['id'] == item_id:
                        item = itm
                        category_id = cat_id
                        break
                if item:
                    break
            
            if item:
                item_total = item['price'] * quantity
                total += item_total
                text += f"‚Ä¢ {item['name']}\n"
                text += f"  –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {quantity}\n"
                text += f"  –°—É–º–º–∞: {item_total:,} —Ä—É–±.\n"
                text += f"  [–ò–∑–º–µ–Ω–∏—Ç—å](callback:edit_{item_id}_{category_id})\n\n"
        
        text += f"üíé *–ò—Ç–æ–≥–æ: {total:,} —Ä—É–±.*"
        
        keyboard = [
            [
                InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë", callback_data='open_catalog'),
                InlineKeyboardButton("üóë –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É", callback_data='clear_cart')
            ],
            [
                InlineKeyboardButton("üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", callback_data='checkout'),
                InlineKeyboardButton("üéÅ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏", callback_data='open_catalog')
            ]
        ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if update.callback_query:
        await update.callback_query.edit_message_text(
            text, 
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )
    else:
        await update.message.reply_text(
            text, 
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )

# –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É
async def add_to_cart(update: Update, context: ContextTypes.DEFAULT_TYPE, item_id: int, category_id: str):
    user_id = update.effective_user.id
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ—Ä–∑–∏–Ω—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    if user_id not in user_carts:
        user_carts[user_id] = {}
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É
    if item_id in user_carts[user_id]:
        user_carts[user_id][item_id] += 1
    else:
        user_carts[user_id][item_id] = 1
    
    await update.callback_query.answer(f"–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É! üõí")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∫–æ—Ä–∑–∏–Ω—É
    await show_cart(update, context)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –∑–∞–ø—Ä–æ—Å–æ–≤
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    data = query.data
    
    if data == 'open_catalog':
        await show_categories(update, context)
    
    elif data == 'view_cart':
        await show_cart(update, context)
    
    elif data == 'back_to_categories':
        await show_categories(update, context)
    
    elif data == 'help':
        await help_command(update, context)
    
    elif data == 'search_gifts':
        await search_gifts(update, context)
    
    elif data == 'clear_cart':
        user_id = update.effective_user.id
        if user_id in user_carts:
            user_carts[user_id] = {}
        await query.answer("–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞!")
        await show_cart(update, context)
    
    elif data == 'checkout':
        await checkout(update, context)
    
    elif data.startswith('category_'):
        category_id = data.split('_')[1]
        await show_category_items(update, context, category_id)
    
    elif data.startswith('add_to_cart_'):
        _, _, item_id, category_id = data.split('_')
        await add_to_cart(update, context, int(item_id), category_id)
    
    elif data.startswith('item_'):
        _, item_id, category_id = data.split('_')
        await show_item_details(update, context, int(item_id), category_id)

# –ü–æ–∏—Å–∫ –ø–æ–¥–∞—Ä–∫–æ–≤
async def search_gifts(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = """
üîç *–ü–æ–∏—Å–∫ –ø–æ–¥–∞—Ä–∫–æ–≤*

–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–¥–∞—Ä–∫–æ–≤.
–ù–∞–ø—Ä–∏–º–µ—Ä: "–∫–Ω–∏–≥–∞", "—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞", "–¥–ª—è –º–∞–º—ã", "–Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è"

‚ú® *–°–æ–≤–µ—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞:*
‚Ä¢ –£–∫–∞–∂–∏—Ç–µ –ø–æ–≤–æ–¥ (–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, –Ω–æ–≤—ã–π –≥–æ–¥)
‚Ä¢ –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è (–¥–ª—è –º—É–∂—á–∏–Ω—ã, –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞)
‚Ä¢ –£–∫–∞–∂–∏—Ç–µ –±—é–¥–∂–µ—Ç (–¥–æ 5000 —Ä—É–±.)
    """
    
    keyboard = [
        [InlineKeyboardButton("üìÇ –ö–∞—Ç–∞–ª–æ–≥", callback_data='open_catalog')],
        [InlineKeyboardButton("üõí –ö–æ—Ä–∑–∏–Ω–∞", callback_data='view_cart')]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.callback_query.edit_message_text(
        text, 
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

# –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
async def checkout(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    cart = user_carts.get(user_id, {})
    
    if not cart:
        await update.callback_query.answer("–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!")
        return
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥
    total = 0
    items_list = []
    
    for item_id, quantity in cart.items():
        for category in CATALOG.values():
            for item in category['items']:
                if item['id'] == item_id:
                    total += item['price'] * quantity
                    items_list.append(f"{item['name']} x{quantity}")
                    break
    
    text = f"""
üí≥ *–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞*

üéÅ *–í–∞—à –∑–∞–∫–∞–∑:*
{chr(10).join(items_list)}

üí∞ *–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞:* {total:,} —Ä—É–±.

üì¶ *–î–æ—Å—Ç–∞–≤–∫–∞:* 500 —Ä—É–±.
üíé *–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:* {total + 500:,} —Ä—É–±.

üìù *–î–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏:*
–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –∞–¥—Ä–µ—Å –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –≤ –æ—Ç–≤–µ—Ç–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.

‚è≥ *–°—Ä–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏:* 1-2 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è
üöö *–°—Ä–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏:* 3-7 –¥–Ω–µ–π
    """
    
    keyboard = [
        [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑", callback_data='confirm_order')],
        [InlineKeyboardButton("‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É", callback_data='view_cart')],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data='open_catalog')]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.callback_query.edit_message_text(
        text, 
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

# –ö–æ–º–∞–Ω–¥–∞ /help
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    help_text = """
‚ùì *–ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞*

*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
üéÅ `/catalog` - –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –ø–æ–¥–∞—Ä–∫–æ–≤
üõí `/cart` - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ—Ä–∑–∏–Ω—É
üîç `/search` - –ü–æ–∏—Å–∫ –ø–æ–¥–∞—Ä–∫–æ–≤
‚ùì `/help` - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

*–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:*
1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥ –∫–æ–º–∞–Ω–¥–æ–π /catalog
2. –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ–¥–∞—Ä–∫–æ–≤
3. –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
4. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É
5. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞

*–§—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞:*
‚Ä¢ üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–¥–∞—Ä–∫–æ–≤
‚Ä¢ üéÅ –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–∞—Ö
‚Ä¢ üõí –ö–æ—Ä–∑–∏–Ω–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏
‚Ä¢ üí≥ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
‚Ä¢ üîç –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É

üìû *–ü–æ–¥–¥–µ—Ä–∂–∫–∞:*
–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –ø–∏—à–∏—Ç–µ: @support
    """
    
    keyboard = [
        [InlineKeyboardButton("üéÅ –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥", callback_data='open_catalog')],
        [InlineKeyboardButton("üõí –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞", callback_data='view_cart')]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if update.callback_query:
        await update.callback_query.edit_message_text(
            help_text, 
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )
    else:
        await update.message.reply_text(
            help_text, 
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è –ø–æ–∏—Å–∫–∞)
async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.lower()
    user_id = update.effective_user.id
    
    # –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É
    if len(text) > 2:  # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤
        found_items = []
        
        for category_id, category_data in CATALOG.items():
            for item in category_data['items']:
                if text in item['name'].lower():
                    found_items.append((item, category_id))
        
        if found_items:
            response = f"üîç *–ù–∞–π–¥–µ–Ω–æ {len(found_items)} –ø–æ–¥–∞—Ä–∫–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É \"{text}\":*\n\n"
            
            for idx, (item, category_id) in enumerate(found_items[:5], 1):  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
                response += f"{idx}. *{item['name']}*\n"
                response += f"   üí∞ –¶–µ–Ω–∞: {item['price']:,} —Ä—É–±.\n"
                response += f"   üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category_data['name']}\n"
                response += f"   [–ü–æ–¥—Ä–æ–±–Ω–µ–µ](callback:item_{item['id']}_{category_id})\n\n"
            
            if len(found_items) > 5:
                response += f"*... –∏ –µ—â—ë {len(found_items) - 5} –ø–æ–¥–∞—Ä–∫–æ–≤*\n"
            
            keyboard = [
                [InlineKeyboardButton("üéÅ –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥", callback_data='open_catalog')],
                [InlineKeyboardButton("üîç –ù–æ–≤—ã–π –ø–æ–∏—Å–∫", callback_data='search_gifts')]
            ]
            
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            await update.message.reply_text(
                response,
                reply_markup=reply_markup,
                parse_mode='Markdown'
            )
            return
    
    # –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–æ–µ
    if len(text) > 2:
        await update.message.reply_text(
            "üòî –ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
            "‚Ä¢ –î—Ä—É–≥–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞\n"
            "‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥ –∫–æ–º–∞–Ω–¥–æ–π /catalog\n"
            "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /search –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫"
        )

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    # –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
    TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê"
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("catalog", catalog))
    application.add_handler(CommandHandler("cart", show_cart))
    application.add_handler(CommandHandler("help", help_command))
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    application.add_handler(CallbackQueryHandler(button_handler))
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    application.run_polling(allowed_updates=Update.ALL_UPDATES)

if __name__ == '__main__':
    main()
